Ãrbol de archivos del directorio: api
================================================================================

## ğŸŒ³ ESTRUCTURA DE ARCHIVOS

â”‚   â”œâ”€â”€ ğŸ“„ BugHunterSagaApiApplication.java
â”‚   â”œâ”€â”€ ğŸ“ application/
â”‚   â”‚   â”œâ”€â”€ ğŸ“ dto/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ CompleteLessonCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ForgotPasswordCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LoginUserCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ RegisterUserCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserAccountCommand.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserSettingsCommand.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ port/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ in/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ClaimTreasureResult.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ClaimTreasureUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ CompleteLessonResult.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ CompleteLessonUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ForgotPasswordUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetLeaderboardUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModuleProblemsUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModuleUnitUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModulesUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetShopItemsUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetUserProfileUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetUserStatsUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LoginUserUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PurchaseItemUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ RegisterUserUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserAccountUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserSettingsUseCase.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStatsResult.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ out/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ EmailSenderPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardData.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PasswordEncoderPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProblemRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItemRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ TokenGeneratorPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UnitRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInventoryRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgressRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfileRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreakRepositoryPort.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserXpHistoryRepositoryPort.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ service/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ClaimTreasureService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ CompleteLessonService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ForgotPasswordService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetLeaderboardService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModuleProblemsService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModuleUnitService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetModulesService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetShopItemsService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetUserProfileService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GetUserStatsService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LoginUserService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ PurchaseItemService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ RegisterUserService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserAccountService.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UpdateUserSettingsService.java
â”‚   â”œâ”€â”€ ğŸ“ domain/
â”‚   â”‚   â”œâ”€â”€ ğŸ“ exception/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ EmailAlreadyExistsException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ InsufficientFundsException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ InvalidCredentialsException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonAlreadyCompletedException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonNotFoundException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleNotFoundException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ResourceNotFoundException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ TreasureAlreadyClaimedException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserNotFoundException.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UsernameAlreadyExistsException.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ model/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AuthToken.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ FullUserProfile.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Leaderboard.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardEntry.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Lesson.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Module.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Problem.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItem.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ Unit.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ User.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInventory.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgress.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfile.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreak.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserXpHistory.java
â”‚   â”œâ”€â”€ ğŸ“ infrastructure/
â”‚   â”‚   â”œâ”€â”€ ğŸ“ adapters/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ email/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ConsoleEmailSenderAdapter.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ BeanConfiguration.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ OpenAPIConfig.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ persistence/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ adapter/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProblemRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItemRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UnitRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInventoryRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgressRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfileRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreakRepositoryAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserXpHistoryRepositoryAdapter.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ entity/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeagueEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProblemEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItemEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UnitEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInventoryEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgressEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgressId.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfileEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreakEntity.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreakId.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserXpHistoryEntity.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ mapper/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ContentPersistenceMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GamificationPersistenceMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProgressPersistenceMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserPersistenceMapper.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ repository/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProblemJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItemJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UnitJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInventoryJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLessonProgressJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfileJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStreakJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserXpHistoryJpaRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ projections/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardProjection.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ security/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ adapter/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ JwtTokenGeneratorAdapter.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ SpringPasswordEncoderAdapter.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ config/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ SecurityConfiguration.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ filter/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ JwtAuthenticationFilter.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ jwt/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ JwtUtil.java
â”‚   â”‚   â”œâ”€â”€ ğŸ“ web/
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ controller/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AuthController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ContentController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GamificationController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProgressController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ SwaggerRedirectController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserController.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ dto/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AuthResponseDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ErrorDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ForgotPasswordDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LeaderboardEntryDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonCompletionResponseDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonResultDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ LessonTileDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ModuleResponseDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProblemDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ShopItemDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UnitDetailDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserAccountUpdateDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserInfoDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserLoginDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserProfileDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserRegistrationDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserSettingsUpdateDTO.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserStatsDTO.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ exception/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GlobalApiExceptionHandler.java
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“ mapper/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ AuthApiMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ContentApiMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ GamificationApiMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ ProgressApiMapper.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ UserApiMapper.java


================================================================================
## ğŸ“„ CONTENIDO DETALLADO DE ARCHIVOS
================================================================================

================================================================================
ğŸ“„ CONTENIDO DE: BugHunterSagaApiApplication.java
================================================================================

package com.bughuntersaga.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class BugHunterSagaApiApplication {

    public static void main(String[] args) {
        SpringApplication.run(BugHunterSagaApiApplication.class, args);
    }

}


================================================================================
ğŸ“„ CONTENIDO DE: application/dto/CompleteLessonCommand.java
================================================================================

    package com.bughuntersaga.api.application.dto;

    import lombok.Builder;
import lombok.Getter;


    @Getter
    @Builder
    public class CompleteLessonCommand {
        private final Integer lessonId;
        private final Integer correctAnswerCount;
        private final Integer incorrectAnswerCount;
        private final Long timeTakenMs;
        private final Boolean isPractice;

    }


================================================================================
ğŸ“„ CONTENIDO DE: application/dto/ForgotPasswordCommand.java
================================================================================
package com.bughuntersaga.api.application.dto;

import lombok.Builder;
import lombok.Getter;

/**
 * Comando para el caso de uso ForgotPassword.
 */
@Getter
@Builder
public class ForgotPasswordCommand {
    private final String email;
}

================================================================================
ğŸ“„ CONTENIDO DE: application/dto/LoginUserCommand.java
================================================================================
package com.bughuntersaga.api.application.dto;

import lombok.Builder;
import lombok.Getter;

@Getter
@Builder
public class LoginUserCommand {
    private final String emailOrUsername;
    private final String password;
}

================================================================================
ğŸ“„ CONTENIDO DE: application/dto/RegisterUserCommand.java
================================================================================
package com.bughuntersaga.api.application.dto;

import lombok.Builder;
import lombok.Getter;

@Getter
@Builder
public class RegisterUserCommand {
    private final String username;
    private final String name;
    private final String email;
    private final String rawPassword;
}


================================================================================
ğŸ“„ CONTENIDO DE: application/dto/UpdateUserAccountCommand.java
================================================================================
package com.bughuntersaga.api.application.dto;

import lombok.Builder;
import lombok.Getter;

/**
 * Comando para el caso de uso UpdateUserAccount.
 */
@Getter
@Builder
public class UpdateUserAccountCommand {
    private final String name;
    private final String username;
}

================================================================================
ğŸ“„ CONTENIDO DE: application/dto/UpdateUserSettingsCommand.java
================================================================================
package com.bughuntersaga.api.application.dto;

import lombok.Builder;
import lombok.Getter;

/**
 * Comando para el caso de uso UpdateUserSettings.
 */
@Getter
@Builder
public class UpdateUserSettingsCommand {
    private final Integer dailyXpGoal;
    private final Boolean soundEffectsEnabled;
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/ClaimTreasureResult.java
================================================================================
package com.bughuntersaga.api.application.port.in;

/**
 * Objeto de dominio que representa el resultado de reclamar un tesoro.
 * Usamos un 'record' de Java para un DTO inmutable simple.
 *
 * Debe estar en su propio archivo .java ya que es 'public'.
 */
public record ClaimTreasureResult(int lingotsEarned, int totalLingots) {}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/ClaimTreasureUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

/**
 * Caso de uso para reclamar un tesoro (lecciÃ³n de tipo 'treasure').
 */
public interface ClaimTreasureUseCase {

    /**
     * Permite a un usuario autenticado reclamar un tesoro.
     *
     * @param lessonId ID de la lecciÃ³n (debe ser tipo 'treasure')
     * @return Un objeto ClaimTreasureResult con los lingots ganados y el total actualizado.
     * @throws com.bughuntersaga.api.domain.exception.LessonNotFoundException si la lecciÃ³n no existe.
     * @throws com.bughuntersaga.api.domain.exception.TreasureAlreadyClaimedException si ya fue reclamado.
     * @throws com.bughuntersaga.api.domain.exception.UserNotFoundException si el usuario o perfil no se encuentra.
     */
    ClaimTreasureResult claimTreasure(Integer lessonId);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/CompleteLessonResult.java
================================================================================
package com.bughuntersaga.api.application.port.in;

/**
 * Objeto de dominio que representa el resultado de completar una lecciÃ³n.
 * Es 'public' para ser accesible desde el servicio.
 */
public record CompleteLessonResult(
        int xpEarned,
        int lingotsEarned,
        int newTotalLingots,
        int newStreak
) {}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/CompleteLessonUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.CompleteLessonCommand;

/**
 * Caso de uso para registrar la finalizaciÃ³n de una lecciÃ³n.
 */
public interface CompleteLessonUseCase {

    /**
     * Maneja la lÃ³gica de negocio de completar una lecciÃ³n.
     *
     * @param command DTO con los detalles de la lecciÃ³n completada.
     * @return Un objeto CompleteLessonResult con las recompensas obtenidas.
     * @throws com.bughuntersaga.api.domain.exception.LessonAlreadyCompletedException si la lecciÃ³n ya fue completada.
     */
    CompleteLessonResult handle(CompleteLessonCommand command);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/ForgotPasswordUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.ForgotPasswordCommand;

/**
 * Caso de uso para iniciar el flujo de reseteo de contraseÃ±a.
 */
public interface ForgotPasswordUseCase {
    /**
     * Maneja la lÃ³gica de negocio para el reseteo de contraseÃ±a.
     *
     * @param command El comando que contiene el email.
     * @return void - Este caso de uso no devuelve datos.
     */
    void handle(ForgotPasswordCommand command);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetLeaderboardUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.domain.model.Leaderboard;

/**
 * Caso de uso para obtener la tabla de clasificaciÃ³n (leaderboard).
 */
public interface GetLeaderboardUseCase {
    /**
     * Obtiene el leaderboard semanal de la liga actual del usuario.
     */
    Leaderboard getLeaderboard();
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetModuleProblemsUseCase.java
================================================================================

package com.bughuntersaga.api.application.port.in;


import com.bughuntersaga.api.domain.model.Problem;

import java.util.List;

public interface GetModuleProblemsUseCase {

    List<Problem> getModuleProblems(String moduleName);

}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetModuleUnitUseCase.java
================================================================================

package com.bughuntersaga.api.application.port.in;


import com.bughuntersaga.api.domain.model.Unit;


public interface GetModuleUnitUseCase {

    Unit getModuleUnit(String moduleCode);

}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetModulesUseCase.java
================================================================================

package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.domain.model.Module;
import java.util.List;

public interface GetModulesUseCase {

    List<Module> getModules();

}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetShopItemsUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.domain.model.ShopItem;
import java.util.List;

/**
 * Caso de uso para obtener todos los artÃ­culos de la tienda.
 */
public interface GetShopItemsUseCase {
    List<ShopItem> getShopItems();
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetUserProfileUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.domain.model.FullUserProfile;

/**
 * Caso de uso para obtener el perfil combinado del usuario autenticado.
 */
public interface GetUserProfileUseCase {
    FullUserProfile getProfile();
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/GetUserStatsUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

/**
 * Caso de uso para obtener las estadÃ­sticas de gamificaciÃ³n del usuario autenticado.
 */
public interface GetUserStatsUseCase {

    /**
     * Obtiene las estadÃ­sticas agregadas del usuario actual.
     *
     * @return Un objeto UserStatsResult con todos los datos calculados.
     */
    UserStatsResult getStats();
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/LoginUserUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.LoginUserCommand;
import com.bughuntersaga.api.domain.model.AuthToken;

public interface LoginUserUseCase {

    /**
     * Autentica a un usuario y devuelve un token.
     * @throws com.bughuntersaga.api.domain.exception.InvalidCredentialsException si las credenciales son incorrectas.
     */
    AuthToken login(LoginUserCommand command);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/PurchaseItemUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.port.in.UserStatsResult; // Importar

/**
 * Caso de uso para comprar un artÃ­culo de la tienda.
 */
public interface PurchaseItemUseCase {

    /**
     * Permite a un usuario autenticado comprar un artÃ­culo.
     *
     * @param itemCode El cÃ³digo del artÃ­culo a comprar (ej. "streak-freeze")
     * @return Las estadÃ­sticas actualizadas del usuario (UserStatsResult)
     * @throws com.bughuntersaga.api.domain.exception.ResourceNotFoundException si el artÃ­culo no existe.
     * @throws com.bughuntersaga.api.domain.exception.InsufficientFundsException si el usuario no tiene suficientes lingots.
     */
    UserStatsResult purchaseItem(String itemCode);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/RegisterUserUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.RegisterUserCommand;
import com.bughuntersaga.api.domain.model.AuthToken;

public interface RegisterUserUseCase {
    AuthToken register(RegisterUserCommand command);
}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/UpdateUserAccountUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.UpdateUserAccountCommand;
import com.bughuntersaga.api.domain.model.User;

/**
 * Caso de uso para actualizar los datos de la cuenta (nombre, username) del usuario.
 */
public interface UpdateUserAccountUseCase {
    /**
     * Actualiza los datos de la cuenta y devuelve el User actualizado.
     */
    User updateAccount(UpdateUserAccountCommand command);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/UpdateUserSettingsUseCase.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import com.bughuntersaga.api.application.dto.UpdateUserSettingsCommand;
import com.bughuntersaga.api.domain.model.FullUserProfile;

/**
 * Caso de uso para actualizar la configuraciÃ³n (coach, sonido) del usuario.
 */
public interface UpdateUserSettingsUseCase {
    /**
     * Actualiza las configuraciones y devuelve el perfil completo actualizado.
     */
    FullUserProfile updateSettings(UpdateUserSettingsCommand command);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/in/UserStatsResult.java
================================================================================
package com.bughuntersaga.api.application.port.in;

import java.time.LocalDate;
import java.util.Set;

/**
 * Objeto de dominio que representa las estadÃ­sticas de un usuario.
 * Es 'public' para ser accesible desde el servicio.
 */
public record UserStatsResult(
        int totalXp,
        int totalLingots,
        int currentStreak,
        int xpToday,
        int xpThisWeek,
        Integer leagueRank, // Nulo por ahora (Fase 6)
        Set<LocalDate> activeDays
) {}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/EmailSenderPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.User;

/**
 * Puerto de salida para un servicio de envÃ­o de emails.
 * La implementaciÃ³n (adaptador) podrÃ­a ser SMTP, SendGrid, Mailgun, etc.
 */
public interface EmailSenderPort {

    /**
     * EnvÃ­a un email de reseteo de contraseÃ±a al usuario.
     *
     * @param user El objeto User (que contiene el email)
     * @param token El token de reseteo (ej. "abc-123")
     * @param resetUrlBase La URL base para construir el enlace (ej. "http://localhost:3000/reset-password")
     */
    void sendPasswordResetEmail(User user, String token, String resetUrlBase);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/LeaderboardData.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import java.util.UUID;

/**
 * DTO de datos crudos del leaderboard, transferido desde el
 * Adaptador de Persistencia al Servicio de AplicaciÃ³n.
 */
public record LeaderboardData(
        UUID userId,
        String name,
        int totalXp
) {}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/LeaderboardRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import java.time.ZonedDateTime;
import java.util.List;

/**
 * Puerto de repositorio para obtener datos agregados del leaderboard.
 */
public interface LeaderboardRepositoryPort {
    /**
     * Obtiene los datos del leaderboard (usuarios y su XP total)
     * dentro de un rango de fechas especÃ­fico.
     *
     * @param start Rango de inicio (Lunes)
     * @param end Rango de fin (Domingo)
     * @return Lista de datos crudos del leaderboard
     */
    List<LeaderboardData> findLeaderboardData(ZonedDateTime start, ZonedDateTime end);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/LessonRepositoryPort.java
================================================================================

package com.bughuntersaga.api.application.port.out;


import com.bughuntersaga.api.domain.model.Lesson;

import java.util.List;
import java.util.Optional;

public interface LessonRepositoryPort {
    Optional<Lesson> findById(Integer id);
    List<Lesson> findByUnitId(Integer unitId);
}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/ModuleRepositoryPort.java
================================================================================

package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.Module;
import java.util.List;
import java.util.Optional;

/**
 * Puerto para el repositorio de mÃ³dulos.
 */
public interface ModuleRepositoryPort {
    List<Module> findAll();
    Optional<Module> findById(Integer id);
    Optional<Module> findByCode(String code);
}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/PasswordEncoderPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

public interface PasswordEncoderPort {
    /**
     * Codifica una contraseÃ±a en texto plano.
     */
    String encode(String rawPassword);

    /**
     * Compara una contraseÃ±a en texto plano con una ya codificada.
     */
    boolean matches(String rawPassword, String encodedPassword);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/ProblemRepositoryPort.java
================================================================================

package com.bughuntersaga.api.application.port.out;


import com.bughuntersaga.api.domain.model.Problem;

import java.util.List;
import java.util.Optional;

/**
 * Puerto para el repositorio de problemas.
 */
public interface ProblemRepositoryPort {
    List<Problem> findProblemsByModuleCode(String moduleCode);
    Optional<Problem> findById(Integer id);
    List<Problem> findByLessonId(Integer lessonId);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/ShopItemRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.ShopItem;
import java.util.List;
import java.util.Optional;

public interface ShopItemRepositoryPort {
    /**
     * Obtiene todos los artÃ­culos de la tienda.
     */
    List<ShopItem> findAll();

    /**
     * Busca un artÃ­culo por su cÃ³digo Ãºnico.
     */
    Optional<ShopItem> findByItemCode(String itemCode);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/TokenGeneratorPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

public interface TokenGeneratorPort {
    /**
     * Genera un token (JWT) para un username especÃ­fico.
     */
    String generateToken(String username);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UnitRepositoryPort.java
================================================================================

package com.bughuntersaga.api.application.port.out;


import com.bughuntersaga.api.domain.model.Unit;

import java.util.List;
import java.util.Optional;

public interface UnitRepositoryPort {

    /**
     * Obtiene la primera unidad de un mÃ³dulo.
     *
     * @param moduleCode CÃ³digo del mÃ³dulo
     * @return Primera unidad con sus lecciones
     */
    Optional<Unit> findFirstUnitByModuleCode(String moduleCode);

    /**
     * Obtiene todas las unidades de un mÃ³dulo.
     *
     * @param moduleCode CÃ³digo del mÃ³dulo
     * @return Lista de unidades
     */
    List<Unit> findUnitsByModuleCode(String moduleCode);

    /**
     * Obtiene una unidad por su ID, incluyendo sus lecciones.
     *
     * @param unitId ID de la unidad
     * @return Unidad con sus lecciones
     */
    Optional<Unit> findByIdWithLessons(Integer unitId);

}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserInventoryRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.UserInventory;

import java.util.Optional;
import java.util.UUID;

/**
 * Puerto de repositorio para el inventario de artÃ­culos del usuario.
 */
public interface UserInventoryRepositoryPort {
    /**
     * Busca un artÃ­culo en el inventario por usuario y cÃ³digo de item.
     */
    Optional<UserInventory> findByUserIdAndItemCode(UUID userId, String itemCode);

    /**
     * Guarda (crea o actualiza) un artÃ­culo en el inventario.
     */
    UserInventory save(UserInventory inventory);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserLessonProgressRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.UserLessonProgress;

import java.util.Set;
import java.util.UUID;

public interface UserLessonProgressRepositoryPort {

    /**
     * Obtiene un conjunto de IDs de lecciones completadas por un usuario.
     * (Lo usamos en la Fase 2/4 para el endpoint /unit)
     */
    Set<Integer> findCompletedLessonIdsByUserId(UUID userId);

    /**
     * Verifica si un registro de progreso especÃ­fico existe.
     */
    boolean existsByUserIdAndLessonId(UUID userId, Integer lessonId);

    /**
     * Guarda un nuevo registro de progreso de lecciÃ³n.
     */
    UserLessonProgress save(UserLessonProgress progress);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserProfileRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.UserProfile;
import java.util.Optional;
import java.util.UUID;

public interface UserProfileRepositoryPort {
    UserProfile save(UserProfile userProfile);
    Optional<UserProfile> findById(UUID userId);
}


================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.User;
import java.util.Optional;
import java.util.UUID;

public interface UserRepositoryPort {

    /**
     * Guarda o actualiza un usuario.
     */
    User save(User user);

    /**
     * Busca un usuario por su username.
     */
    Optional<User> findByUsername(String username);

    /**
     * Busca un usuario por su email.
     */
    Optional<User> findByEmail(String email);

    /**
     * Busca un usuario por username O email (para el login).
     */
    Optional<User> findByUsernameOrEmail(String username, String email);

    boolean existsByUsernameAndIdNot(String username, UUID userId);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserStreakRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.UserStreak;
import java.time.LocalDate;
import java.util.Set;
import java.util.UUID;

public interface UserStreakRepositoryPort {
    /**
     * Guarda un nuevo registro de actividad (racha).
     */
    UserStreak save(UserStreak streak);

    /**
     * Obtiene todos los dÃ­as de actividad de un usuario.
     * Se usa para calcular la racha actual.
     */
    Set<LocalDate> findAllActivityDatesByUserId(UUID userId);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/port/out/UserXpHistoryRepositoryPort.java
================================================================================
package com.bughuntersaga.api.application.port.out;

import com.bughuntersaga.api.domain.model.UserXpHistory;

import java.time.ZonedDateTime;
import java.util.UUID;

public interface UserXpHistoryRepositoryPort {
    /**
     * Guarda un nuevo registro de XP. (Fase 3)
     */
    UserXpHistory save(UserXpHistory history);

    /**
     * Suma el XP total de un usuario.
     */
    int sumTotalXpByUserId(UUID userId);

    /**
     * Suma el XP de un usuario entre dos fechas.
     */
    int sumXpEarnedBetween(UUID userId, ZonedDateTime start, ZonedDateTime end);
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/ClaimTreasureService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.ClaimTreasureResult;
import com.bughuntersaga.api.application.port.in.ClaimTreasureUseCase;
import com.bughuntersaga.api.application.port.out.LessonRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserLessonProgressRepositoryPort;
import com.bughuntersaga.api.domain.exception.LessonNotFoundException;
import com.bughuntersaga.api.domain.exception.TreasureAlreadyClaimedException;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.Lesson;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserLessonProgress;
import com.bughuntersaga.api.domain.model.UserProfile;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.ZonedDateTime;

@Service
@RequiredArgsConstructor
public class ClaimTreasureService implements ClaimTreasureUseCase {


    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;
    private final LessonRepositoryPort lessonRepositoryPort;
    private final UserLessonProgressRepositoryPort userLessonProgressRepositoryPort;

    @Value("${app.rewards.treasure:20}")
    private int TREASURE_REWARD_LINGOTS;

    @Override
    @Transactional // Â¡MUY IMPORTANTE! Esto asegura atomicidad
    public ClaimTreasureResult claimTreasure(Integer lessonId) {

        // 1. Obtener usuario autenticado (LÃ³gica de Seguridad)
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        User currentUser = userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));

        // 2. Validar la LecciÃ³n (LÃ³gica de Negocio)
        Lesson lesson = lessonRepositoryPort.findById(lessonId)
                .orElseThrow(() -> new LessonNotFoundException(lessonId));

        if (!"treasure".equalsIgnoreCase(lesson.getType())) {
            throw new IllegalArgumentException("La lecciÃ³n no es un tesoro.");
        }

        // 3. Validar que no se haya reclamado (LÃ³gica de Negocio)
        boolean alreadyClaimed = userLessonProgressRepositoryPort
                .existsByUserIdAndLessonId(currentUser.getId(), lessonId);

        if (alreadyClaimed) {
            throw new TreasureAlreadyClaimedException("Tesoro ya reclamado por el usuario.");
        }

        // 4. Otorgar recompensa (LÃ³gica de Negocio)
        UserProfile userProfile = userProfileRepositoryPort.findById(currentUser.getId())
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));

        userProfile.setLingots(userProfile.getLingots() + TREASURE_REWARD_LINGOTS);
        userProfileRepositoryPort.save(userProfile); // Guardar el perfil actualizado

        // 5. Marcar como reclamado (LÃ³gica de Negocio)
        UserLessonProgress progress = UserLessonProgress.builder()
                .userId(currentUser.getId())
                .lessonId(lessonId)
                .completedAt(ZonedDateTime.now())
                .build();

        userLessonProgressRepositoryPort.save(progress);

        // 6. Devolver resultado
        return new ClaimTreasureResult(TREASURE_REWARD_LINGOTS, userProfile.getLingots());
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/CompleteLessonService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.CompleteLessonCommand;
import com.bughuntersaga.api.application.port.in.CompleteLessonResult;
import com.bughuntersaga.api.application.port.in.CompleteLessonUseCase;
import com.bughuntersaga.api.application.port.out.*;
import com.bughuntersaga.api.domain.exception.LessonAlreadyCompletedException;
import com.bughuntersaga.api.domain.exception.LessonNotFoundException;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.*;
import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Clock;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.Set;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class CompleteLessonService implements CompleteLessonUseCase {

    // Puertos requeridos por este caso de uso
    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;
    private final LessonRepositoryPort lessonRepositoryPort;
    private final UserLessonProgressRepositoryPort userLessonProgressRepositoryPort;
    private final UserXpHistoryRepositoryPort userXpHistoryRepositoryPort;
    private final UserStreakRepositoryPort userStreakRepositoryPort;

    // Para consistencia en fechas (y facilitar pruebas)
    private final Clock clock;
    private static final ZoneId UTC_ZONE = ZoneId.of("UTC");

    // Valores de recompensa (configurables)
    @Value("${app.rewards.lesson.baseXp:10}")
    private int BASE_XP;

    @Value("${app.rewards.lesson.lingot:5}")
    private int LINGOT_REWARD;

    @Override
    @Transactional
    public CompleteLessonResult handle(CompleteLessonCommand command) {

        // 1. OBTENER ESTADO ACTUAL
        ZonedDateTime now = ZonedDateTime.now(clock.withZone(UTC_ZONE));
        LocalDate today = now.toLocalDate();

        User currentUser = getCurrentUser();
        UserProfile userProfile = getUserProfile(currentUser.getId());

        validateLesson(command.getLessonId(), currentUser.getId());

        // 2. CALCULAR RECOMPENSAS
        int xpEarned = BASE_XP + command.getCorrectAnswerCount();
        int lingotsEarned = command.getIsPractice() ? 0 : LINGOT_REWARD;

        // 3. LÃ“GICA DE PERSISTENCIA

        // Guardar progreso de lecciÃ³n
        userLessonProgressRepositoryPort.save(UserLessonProgress.builder()
                .userId(currentUser.getId())
                .lessonId(command.getLessonId())
                .completedAt(now)
                .build());

        // Guardar historial de XP
        userXpHistoryRepositoryPort.save(UserXpHistory.builder()
                .userId(currentUser.getId())
                .xpEarned(xpEarned)
                .sourceType("LESSON")
                .sourceId(command.getLessonId())
                .createdAt(now)
                .build());

        // Actualizar Lingots
        int newTotalLingots = userProfile.getLingots() + lingotsEarned;
        userProfile.setLingots(newTotalLingots);
        userProfileRepositoryPort.save(userProfile);

        // 4. LÃ“GICA DE RACHA
        int newStreak = calculateAndUpdateStreak(currentUser.getId(), today);

        // 5. DEVOLVER RESULTADO
        return new CompleteLessonResult(xpEarned, lingotsEarned, newTotalLingots, newStreak);
    }

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private UserProfile getUserProfile(UUID userId) {
        return userProfileRepositoryPort.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));
    }

    private void validateLesson(Integer lessonId, UUID userId) {
        // Validar que la lecciÃ³n existe (lanza excepciÃ³n si no)
        lessonRepositoryPort.findById(lessonId)
                .orElseThrow(() -> new LessonNotFoundException(lessonId));

        // Validar que no se haya completado
        boolean alreadyCompleted = userLessonProgressRepositoryPort
                .existsByUserIdAndLessonId(userId, lessonId);

        if (alreadyCompleted) {
            throw new LessonAlreadyCompletedException("LecciÃ³n ya completada: " + lessonId);
        }
    }

    /**
     * LÃ³gica central de cÃ¡lculo de racha.
     */
    private int calculateAndUpdateStreak(UUID userId, LocalDate today) {
        Set<LocalDate> allDates = userStreakRepositoryPort.findAllActivityDatesByUserId(userId);

        // Si el usuario ya jugÃ³ hoy, no guardamos de nuevo, solo calculamos
        if (!allDates.contains(today)) {
            userStreakRepositoryPort.save(UserStreak.builder()
                    .userId(userId)
                    .activityDate(today)
                    .build());

            // AÃ±adimos 'hoy' al set para el cÃ¡lculo
            allDates.add(today);
        }

        // Calculamos la racha contando hacia atrÃ¡s desde 'hoy'
        int currentStreak = 0;
        LocalDate dayToCheck = today;

        while (allDates.contains(dayToCheck)) {
            currentStreak++;
            dayToCheck = dayToCheck.minusDays(1);
        }

        return currentStreak;
    }


}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/ForgotPasswordService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.ForgotPasswordCommand;
import com.bughuntersaga.api.application.port.in.ForgotPasswordUseCase;
import com.bughuntersaga.api.application.port.out.EmailSenderPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.model.User;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Clock;
import java.time.ZonedDateTime;
import java.util.Optional;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Slf4j
public class ForgotPasswordService implements ForgotPasswordUseCase {

    private final UserRepositoryPort userRepositoryPort;
    private final EmailSenderPort emailSenderPort;
    private final Clock clock; // (AsegÃºrate de tener este Bean de Fase 3)

    @Value("${app.frontend.url:http://localhost:3000}")
    private String frontendBaseUrl;

    @Value("${app.security.reset-token-duration-hours:1}")
    private long resetTokenDurationHours;

    @Override
    @Transactional
    public void handle(ForgotPasswordCommand command) {

        Optional<User> userOptional = userRepositoryPort.findByEmail(command.getEmail());

        // --- Â¡PROTECCIÃ“N DE SEGURIDAD! ---
        // Si el usuario no existe, NO lanzamos un error.
        // Simplemente terminamos la ejecuciÃ³n silenciosamente.
        // Esto previene que los atacantes "adivinen" quÃ© emails estÃ¡n registrados.
        if (userOptional.isEmpty()) {
            log.warn("Solicitud de reseteo para email no existente: {}", command.getEmail());
            return; // No hacer nada
        }

        User user = userOptional.get();
        ZonedDateTime now = ZonedDateTime.now(clock);

        // 1. Generar Token
        String token = UUID.randomUUID().toString();

        // 2. Establecer ExpiraciÃ³n
        user.setPasswordResetToken(token);
        user.setPasswordResetExpires(now.plusHours(resetTokenDurationHours));

        // 3. Guardar en BD
        userRepositoryPort.save(user);

        // 4. Pedir al puerto de email que envÃ­e
        String resetUrlBase = frontendBaseUrl + "/reset-password";
        emailSenderPort.sendPasswordResetEmail(user, token, resetUrlBase);

        log.info("Token de reseteo generado para el usuario: {}", user.getUsername());
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetLeaderboardService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetLeaderboardUseCase;
import com.bughuntersaga.api.application.port.out.LeaderboardData;
import com.bughuntersaga.api.application.port.out.LeaderboardRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.Leaderboard;
import com.bughuntersaga.api.domain.model.LeaderboardEntry;
import com.bughuntersaga.api.domain.model.User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.*;
import java.time.temporal.TemporalAdjusters;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GetLeaderboardService implements GetLeaderboardUseCase {

    private final LeaderboardRepositoryPort leaderboardRepositoryPort;
    private final UserRepositoryPort userRepositoryPort;
    private final Clock clock;

    private static final ZoneId UTC_ZONE = ZoneId.of("UTC");

    @Override
    public Leaderboard getLeaderboard() {
        // 1. OBTENER ESTADO ACTUAL
        User currentUser = getCurrentUser();
        ZonedDateTime now = ZonedDateTime.now(clock.withZone(UTC_ZONE));

        // 2. CALCULAR RANGO DE LA SEMANA (Lunes 00:00 a Domingo 23:59 en UTC)
        ZonedDateTime startOfWeek = now.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY))
                .toLocalDate().atStartOfDay(UTC_ZONE);
        ZonedDateTime endOfWeek = now.with(TemporalAdjusters.nextOrSame(DayOfWeek.SUNDAY))
                .toLocalDate().atTime(LocalTime.MAX).atZone(UTC_ZONE);

        // 3. OBTENER DATOS DE LA BD
        List<LeaderboardData> dbData = leaderboardRepositoryPort.findLeaderboardData(startOfWeek, endOfWeek);

        // 4. PROCESAR Y ENRIQUECER (LÃ³gica de Negocio)
        List<LeaderboardEntry> entries = new ArrayList<>();
        int rank = 1;
        for (LeaderboardData data : dbData) {
            entries.add(LeaderboardEntry.builder()
                    .rank(rank++)
                    .name(data.name())
                    .xp(data.totalXp())
                    .isCurrentUser(data.userId().equals(currentUser.getId()))
                    .build());
        }

        // 5. CALCULAR TIEMPO RESTANTE
        String timeUntilEnd = formatTimeUntilEnd(now, endOfWeek);

        // 6. CONSTRUIR RESULTADO
        return Leaderboard.builder()
                .leagueName("Liga Bronce") // Fijo, como en el OpenAPI
                .timeUntilEnd(timeUntilEnd)
                .users(entries)
                .build();
    }

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private String formatTimeUntilEnd(ZonedDateTime now, ZonedDateTime endOfWeek) {
        Duration duration = Duration.between(now, endOfWeek);
        long days = duration.toDays();
        long hours = duration.toHours() % 24;

        if (days > 0) {
            return String.format("%d dÃ­as %d horas restantes", days, hours);
        } else if (hours > 0) {
            return String.format("%d horas restantes", hours);
        } else {
            return String.format("%d minutos restantes", duration.toMinutes() % 60);
        }
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetModuleProblemsService.java
================================================================================

package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.out.ProblemRepositoryPort;
import com.bughuntersaga.api.domain.model.Problem;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import com.bughuntersaga.api.application.port.in.GetModuleProblemsUseCase;

import java.util.ArrayList;
import java.util.List;


@Service
@RequiredArgsConstructor
public class GetModuleProblemsService implements GetModuleProblemsUseCase {

    private final ProblemRepositoryPort problemRepository;
    @Override
    public List<Problem> getModuleProblems(String moduleName) {
        List<Problem> problems = problemRepository.findProblemsByModuleCode(moduleName);
        return problems;
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetModuleUnitService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetModuleUnitUseCase;
import com.bughuntersaga.api.application.port.out.UnitRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserLessonProgressRepositoryPort;
import com.bughuntersaga.api.domain.model.Unit;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Set;


@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GetModuleUnitService implements GetModuleUnitUseCase {

    private final UnitRepositoryPort unitRepository;
    private final UserRepositoryPort userRepositoryPort;
    private final UserLessonProgressRepositoryPort userLessonProgressRepositoryPort;

    @Override
    public Unit getModuleUnit(String moduleCode) {

        // --- 1. Obtener el usuario autenticado ---
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        String username = authentication.getName(); // Esto viene del token JWT

        User currentUser = userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));

        // --- 2. Obtener la unidad (LÃ³gica de Fase 2) ---
        Unit unit = unitRepository.findFirstUnitByModuleCode(moduleCode)
                .orElseThrow(() -> new RuntimeException("MÃ³dulo no encontrado: " + moduleCode));

        // --- 3. Obtener el progreso del usuario (LÃ³gica de Fase 4) ---
        Set<Integer> completedLessonIds = userLessonProgressRepositoryPort
                .findCompletedLessonIdsByUserId(currentUser.getId());

        // --- 4. Calcular el 'status' real ---
        if (unit.getLessons() != null) {
            unit.getLessons().forEach(lesson -> {
                if (completedLessonIds.contains(lesson.getId())) {
                    lesson.setStatus("COMPLETE"); // Â¡Correcto!
                } else {
                    lesson.setStatus("ACTIVE"); // (LÃ³gica de 'LOCKED' se puede aÃ±adir despuÃ©s)
                }
            });
        }

        return unit;
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetModulesService.java
================================================================================

package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.out.ModuleRepositoryPort;
import com.bughuntersaga.api.domain.model.Module;
import lombok.RequiredArgsConstructor;
import com.bughuntersaga.api.domain.model.Module;
import org.springframework.stereotype.Service;
import com.bughuntersaga.api.application.port.in.GetModulesUseCase;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;


@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GetModulesService implements GetModulesUseCase {

    private final ModuleRepositoryPort moduleRepository;

    @Override
    public List<Module> getModules() {
        List<Module> modules = moduleRepository.findAll();
        return modules;
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetShopItemsService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetShopItemsUseCase;
import com.bughuntersaga.api.application.port.out.ShopItemRepositoryPort;
import com.bughuntersaga.api.domain.model.ShopItem;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GetShopItemsService implements GetShopItemsUseCase {

    private final ShopItemRepositoryPort shopItemRepositoryPort;

    @Override
    public List<ShopItem> getShopItems() {
        return shopItemRepositoryPort.findAll();
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetUserProfileService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetUserProfileUseCase;
import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.FullUserProfile;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserProfile;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.UUID;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
public class GetUserProfileService implements GetUserProfileUseCase {

    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;

    @Override
    public FullUserProfile getProfile() {
        // 1. Obtener usuario autenticado
        User currentUser = getCurrentUser();
        UserProfile userProfile = getUserProfile(currentUser.getId());

        // 2. Combinar en el modelo de dominio
        return FullUserProfile.builder()
                .userId(currentUser.getId())
                .name(currentUser.getName())
                .username(currentUser.getUsername())
                .email(currentUser.getEmail())
                .joinedAt(currentUser.getCreatedAt())
                .lingots(userProfile.getLingots())
                .dailyXpGoal(userProfile.getDailyXpGoal())
                .soundEffectsEnabled(userProfile.getSoundEffectsEnabled())
                .build();
    }

    // --- MÃ©todos de ayuda (reutilizables) ---

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private UserProfile getUserProfile(UUID userId) {
        return userProfileRepositoryPort.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/GetUserStatsService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetUserStatsUseCase;
import com.bughuntersaga.api.application.port.in.UserStatsResult;
import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserStreakRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserXpHistoryRepositoryPort;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserProfile;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Clock;
import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.temporal.TemporalAdjusters;
import java.util.Set;
import java.util.UUID;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true) // Este endpoint es de solo lectura
public class GetUserStatsService implements GetUserStatsUseCase {

    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;
    private final UserXpHistoryRepositoryPort userXpHistoryRepositoryPort;
    private final UserStreakRepositoryPort userStreakRepositoryPort;
    private final Clock clock;

    private static final ZoneId UTC_ZONE = ZoneId.of("UTC");

    @Override
    public UserStatsResult getStats() {

        // 1. OBTENER USUARIO Y ESTADO ACTUAL
        User currentUser = getCurrentUser();
        UUID userId = currentUser.getId();
        UserProfile userProfile = getUserProfile(userId);

        ZonedDateTime now = ZonedDateTime.now(clock.withZone(UTC_ZONE));
        LocalDate today = now.toLocalDate();

        // 2. OBTENER DATOS FÃCILES (DEL PERFIL)
        int totalLingots = userProfile.getLingots();

        // 3. OBTENER DATOS DE RACHA
        Set<LocalDate> activeDays = userStreakRepositoryPort.findAllActivityDatesByUserId(userId);
        int currentStreak = calculateCurrentStreak(activeDays, today);

        // 4. OBTENER DATOS AGREGADOS (XP)
        int totalXp = userXpHistoryRepositoryPort.sumTotalXpByUserId(userId);

        // Calcular rangos de fecha
        ZonedDateTime startOfToday = today.atStartOfDay(UTC_ZONE);
        ZonedDateTime startOfWeek = today.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)).atStartOfDay(UTC_ZONE);

        int xpToday = userXpHistoryRepositoryPort.sumXpEarnedBetween(userId, startOfToday, now);
        int xpThisWeek = userXpHistoryRepositoryPort.sumXpEarnedBetween(userId, startOfWeek, now);

        // 5. CONSTRUIR RESULTADO
        // leagueRank se deja como null (es de Fase 6)

        return new UserStatsResult(
                totalXp,
                totalLingots,
                currentStreak,
                xpToday,
                xpThisWeek,
                null, // leagueRank
                activeDays
        );
    }

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private UserProfile getUserProfile(UUID userId) {
        return userProfileRepositoryPort.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));
    }

    /**
     * LÃ³gica de cÃ¡lculo de racha. (Reutilizada de CompleteLessonService)
     */
    private int calculateCurrentStreak(Set<LocalDate> allDates, LocalDate today) {
        int currentStreak = 0;
        LocalDate dayToCheck = today;

        while (allDates.contains(dayToCheck)) {
            currentStreak++;
            dayToCheck = dayToCheck.minusDays(1);
        }
        return currentStreak;
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/LoginUserService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.LoginUserCommand;
import com.bughuntersaga.api.application.port.in.LoginUserUseCase;
import com.bughuntersaga.api.application.port.out.PasswordEncoderPort;
import com.bughuntersaga.api.application.port.out.TokenGeneratorPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.InvalidCredentialsException;
import com.bughuntersaga.api.domain.model.AuthToken;
import com.bughuntersaga.api.domain.model.User;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Slf4j
@Service
@RequiredArgsConstructor
public class LoginUserService implements LoginUserUseCase {


    private final UserRepositoryPort userRepositoryPort;
    private final PasswordEncoderPort passwordEncoderPort;
    private final TokenGeneratorPort tokenGeneratorPort;

    @Override
    @Transactional(readOnly = true) // Login es de solo lectura
    public AuthToken login(LoginUserCommand command) {
        log.info("Intento de login para: {}", command.getEmailOrUsername());

        // 1. Buscar usuario (usando el puerto)
        User user = userRepositoryPort.findByUsernameOrEmail(command.getEmailOrUsername(), command.getEmailOrUsername())
                .orElseThrow(() -> {
                    log.warn("Login fallido: Usuario no encontrado - {}", command.getEmailOrUsername());
                    // Lanza una excepciÃ³n de dominio, no de infraestructura
                    return new InvalidCredentialsException("Credenciales invÃ¡lidas");
                });

        // 2. Validar contraseÃ±a (usando el puerto)
        if (!passwordEncoderPort.matches(command.getPassword(), user.getPasswordHash())) {
            log.warn("Login fallido: ContraseÃ±a invÃ¡lida para - {}", command.getEmailOrUsername());
            throw new InvalidCredentialsException("Credenciales invÃ¡lidas");
        }

        // 3. Generar token (usando el puerto)
        log.info("ContraseÃ±a vÃ¡lida. Generando token para: {}", user.getUsername());
        String token = tokenGeneratorPort.generateToken(user.getUsername());

        log.info("Login exitoso para: {}", user.getUsername());
        return AuthToken.builder()
                .token(token)
                .user(user)
                .build();
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/PurchaseItemService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.port.in.GetUserStatsUseCase;
import com.bughuntersaga.api.application.port.in.PurchaseItemUseCase;
import com.bughuntersaga.api.application.port.in.UserStatsResult;
import com.bughuntersaga.api.application.port.out.*;
import com.bughuntersaga.api.domain.exception.InsufficientFundsException;
import com.bughuntersaga.api.domain.exception.ResourceNotFoundException;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.*;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Clock;
import java.time.ZonedDateTime;
import java.util.Optional;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class PurchaseItemService implements PurchaseItemUseCase {

    // Puertos
    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;
    private final ShopItemRepositoryPort shopItemRepositoryPort;
    private final UserInventoryRepositoryPort userInventoryRepositoryPort;

    // Casos de uso
    private final GetUserStatsUseCase getUserStatsUseCase; // Para devolver stats actualizados

    private final Clock clock;

    @Override
    @Transactional
    public UserStatsResult purchaseItem(String itemCode) {

        // 1. OBTENER ESTADO ACTUAL
        User currentUser = getCurrentUser();
        UUID userId = currentUser.getId();
        UserProfile userProfile = getUserProfile(userId);

        // 2. OBTENER ARTÃCULO Y VALIDAR
        ShopItem item = shopItemRepositoryPort.findByItemCode(itemCode)
                .orElseThrow(() -> new ResourceNotFoundException("ArtÃ­culo no encontrado: ArtÃ­culo no encontrado: " + itemCode, itemCode));

        // 3. LÃ“GICA DE COMPRA
        if (userProfile.getLingots() < item.getCost()) {
            throw new InsufficientFundsException("Fondos insuficientes. Necesita " + item.getCost() + " lingots.");
        }

        // 4. EJECUTAR TRANSACCIÃ“N

        // Restar lingots
        userProfile.setLingots(userProfile.getLingots() - item.getCost());
        userProfileRepositoryPort.save(userProfile);

        // AÃ±adir a inventario
        Optional<UserInventory> existingInventory = userInventoryRepositoryPort
                .findByUserIdAndItemCode(userId, itemCode);

        UserInventory inventoryToSave;
        if (existingInventory.isPresent()) {
            // Actualizar cantidad
            inventoryToSave = existingInventory.get();
            inventoryToSave.setQuantity(inventoryToSave.getQuantity() + 1);
        } else {
            // Crear nuevo registro
            inventoryToSave = UserInventory.builder()
                    .userId(userId)
                    .itemCode(itemCode)
                    .quantity(1)
                    .createdAt(ZonedDateTime.now(clock))
                    .build();
        }

        userInventoryRepositoryPort.save(inventoryToSave);

        // 5. DEVOLVER STATS ACTUALIZADOS (como pide el OpenAPI)
        // Reutilizamos el caso de uso que ya construimos
        return getUserStatsUseCase.getStats();
    }

    // --- MÃ©todos de ayuda ---

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private UserProfile getUserProfile(UUID userId) {
        return userProfileRepositoryPort.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/RegisterUserService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.RegisterUserCommand;
import com.bughuntersaga.api.application.port.in.RegisterUserUseCase;
import com.bughuntersaga.api.application.port.out.PasswordEncoderPort;
import com.bughuntersaga.api.application.port.out.TokenGeneratorPort;
import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.EmailAlreadyExistsException;
import com.bughuntersaga.api.domain.exception.UsernameAlreadyExistsException;
import com.bughuntersaga.api.domain.model.AuthToken;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserProfile;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Slf4j
@Service
@RequiredArgsConstructor
public class RegisterUserService implements RegisterUserUseCase {

    // --- Â¡ARQUITECTURA CORRECTA! ---
    // Solo depende de interfaces (Puertos)
    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;
    private final PasswordEncoderPort passwordEncoderPort;
    private final TokenGeneratorPort tokenGeneratorPort;

    @Override
    @Transactional
    public AuthToken register(RegisterUserCommand command) {
        log.info("Iniciando registro para el usuario: {}", command.getUsername());

        // 1. Validar duplicados (usando el puerto)
        if (userRepositoryPort.findByUsername(command.getUsername()).isPresent()) {
            throw new UsernameAlreadyExistsException("El username ya existe: " + command.getUsername());
        }
        if (userRepositoryPort.findByEmail(command.getEmail()).isPresent()) {
            throw new EmailAlreadyExistsException("El email ya existe: " + command.getEmail());
        }

        // 2. Codificar password (usando el puerto)
        String passwordHash = passwordEncoderPort.encode(command.getRawPassword());

        // 3. Crear usuario (Modelo de Dominio)
        User newUserDomain = User.builder()
                .username(command.getUsername())
                .email(command.getEmail())
                .passwordHash(passwordHash)
                .name(command.getName())
                .build();

        // 4. Guardar (usando el puerto)
        User savedUserDomain = userRepositoryPort.save(newUserDomain);

        // 5. Crear perfil
        UserProfile newProfile = UserProfile.builder()
                .userId(savedUserDomain.getId())
                .lingots(0)
                .dailyXpGoal(10)
                .soundEffectsEnabled(true)
                .build();

        userProfileRepositoryPort.save(newProfile);

        // 6. Generar token (usando el puerto)
        String token = tokenGeneratorPort.generateToken(savedUserDomain.getUsername());

        return AuthToken.builder()
                .token(token)
                .user(savedUserDomain)
                .build();
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/UpdateUserAccountService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.UpdateUserAccountCommand;
import com.bughuntersaga.api.application.port.in.UpdateUserAccountUseCase;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.exception.UsernameAlreadyExistsException;
import com.bughuntersaga.api.domain.model.User;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@Service
@RequiredArgsConstructor
public class UpdateUserAccountService implements UpdateUserAccountUseCase {

    private final UserRepositoryPort userRepositoryPort;

    @Override
    @Transactional
    public User updateAccount(UpdateUserAccountCommand command) {
        // 1. Obtener usuario actual
        User currentUser = getCurrentUser();

        // 2. Validar unicidad del username (si cambiÃ³)
        if (command.getUsername() != null && !command.getUsername().equals(currentUser.getUsername())) {
            boolean exists = userRepositoryPort.existsByUsernameAndIdNot(command.getUsername(), currentUser.getId());
            if (exists) {
                throw new UsernameAlreadyExistsException("El username ya estÃ¡ en uso: " + command.getUsername());
            }
            currentUser.setUsername(command.getUsername());
        }

        // 3. Aplicar cambios
        if (command.getName() != null) {
            currentUser.setName(command.getName());
        }

        // 4. Guardar y devolver
        return userRepositoryPort.save(currentUser);
    }

    private User getCurrentUser() {
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: application/service/UpdateUserSettingsService.java
================================================================================
package com.bughuntersaga.api.application.service;

import com.bughuntersaga.api.application.dto.UpdateUserSettingsCommand;
import com.bughuntersaga.api.application.port.in.UpdateUserSettingsUseCase;
import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.exception.UserNotFoundException;
import com.bughuntersaga.api.domain.model.FullUserProfile;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserProfile;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List; // IMPORTAR
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class UpdateUserSettingsService implements UpdateUserSettingsUseCase {

    private final UserRepositoryPort userRepositoryPort;
    private final UserProfileRepositoryPort userProfileRepositoryPort;

    // Lista de valores permitidos (definida en tu OpenAPI)
    private static final List<Integer> VALID_XP_GOALS = List.of(1, 10, 20, 30, 50);

    @Override
    @Transactional
    public FullUserProfile updateSettings(UpdateUserSettingsCommand command) {
        // 1. Obtener usuario y perfil
        User currentUser = getCurrentUser();
        UserProfile userProfile = getUserProfile(currentUser.getId());

        // 2. Aplicar cambios (solo si no son nulos)
        if (command.getDailyXpGoal() != null) {

            // --- Â¡NUEVA VALIDACIÃ“N DE REGLA DE NEGOCIO! ---
            if (!VALID_XP_GOALS.contains(command.getDailyXpGoal())) {
                throw new IllegalArgumentException(
                        "Meta de XP invÃ¡lida. Debe ser una de: " + VALID_XP_GOALS
                );
            }
            userProfile.setDailyXpGoal(command.getDailyXpGoal());
        }

        if (command.getSoundEffectsEnabled() != null) {
            userProfile.setSoundEffectsEnabled(command.getSoundEffectsEnabled());
        }

        // 3. Guardar cambios
        UserProfile updatedProfile = userProfileRepositoryPort.save(userProfile);

        // 4. Devolver el perfil combinado actualizado
        return FullUserProfile.builder()
                .userId(currentUser.getId())
                .name(currentUser.getName())
                .username(currentUser.getUsername())
                .email(currentUser.getEmail())
                .joinedAt(currentUser.getCreatedAt())
                .lingots(updatedProfile.getLingots())
                .dailyXpGoal(updatedProfile.getDailyXpGoal())
                .soundEffectsEnabled(updatedProfile.getSoundEffectsEnabled())
                .build();
    }

    // --- MÃ©todos de ayuda ---
    private User getCurrentUser() {
        // ... (cÃ³digo existente)
        String username = SecurityContextHolder.getContext().getAuthentication().getName();
        return userRepositoryPort.findByUsername(username)
                .orElseThrow(() -> new UserNotFoundException("Usuario no encontrado: " + username));
    }

    private UserProfile getUserProfile(UUID userId) {
        // ... (cÃ³digo existente)
        return userProfileRepositoryPort.findById(userId)
                .orElseThrow(() -> new UserNotFoundException("Perfil de usuario no encontrado."));
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/EmailAlreadyExistsException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class EmailAlreadyExistsException extends RuntimeException {

public EmailAlreadyExistsException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/InsufficientFundsException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class InsufficientFundsException extends RuntimeException {

public InsufficientFundsException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/InvalidCredentialsException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class InvalidCredentialsException extends RuntimeException {

public InvalidCredentialsException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/LessonAlreadyCompletedException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class LessonAlreadyCompletedException extends RuntimeException {
    public LessonAlreadyCompletedException(String message) {
        super(message);
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/LessonNotFoundException.java
================================================================================
package com.bughuntersaga.api.domain.exception;

public class LessonNotFoundException extends RuntimeException {
    public LessonNotFoundException(Integer lessonId) {
        super("Lesson not found with id: " + lessonId);
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/ModuleNotFoundException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class ModuleNotFoundException extends RuntimeException {

public ModuleNotFoundException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/ResourceNotFoundException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message) {
        super(message);
    }

    public ResourceNotFoundException(String resourceType, Object id) {
        super(String.format("%s con ID '%s' no encontrado", resourceType, id));
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/TreasureAlreadyClaimedException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class TreasureAlreadyClaimedException extends RuntimeException {

public TreasureAlreadyClaimedException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/UserNotFoundException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class UserNotFoundException extends RuntimeException {

public UserNotFoundException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/exception/UsernameAlreadyExistsException.java
================================================================================

package com.bughuntersaga.api.domain.exception;

import java.lang.RuntimeException;



public class UsernameAlreadyExistsException extends RuntimeException {

public UsernameAlreadyExistsException(String message) {
    super(message);
}

}


================================================================================
ğŸ“„ CONTENIDO DE: domain/model/AuthToken.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.Builder;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
@Builder
public class AuthToken {
    private String token;
    private User user;
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/model/FullUserProfile.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Modelo de dominio que combina User y UserProfile
 * para el endpoint GET /users/me/profile.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class FullUserProfile {
    // Campos de User
    private UUID userId;
    private String name;
    private String username;
    private String email;
    private LocalDateTime joinedAt; // (createdAt de User)

    // Campos de UserProfile
    private Integer lingots;
    private Integer dailyXpGoal;
    private Boolean soundEffectsEnabled;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/Leaderboard.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.List;

/**
 * Entidad de dominio que representa la tabla de clasificaciÃ³n completa.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Leaderboard {
    private String leagueName; // (Fijo por ahora, Fase 6 no implementa ligas)
    private String timeUntilEnd;
    private List<LeaderboardEntry> users;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/LeaderboardEntry.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

/**
 * Entidad de dominio que representa una sola fila en el leaderboard.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class LeaderboardEntry {
    private int rank;
    private String name;
    private int xp;
    private boolean isCurrentUser;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/Lesson.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.*;

@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Lesson {
    private Integer id;
    private Integer unitId;
    private String type;          // "star", "book", "trophy", "treasure", "fast-forward"
    private String description;
    private Integer position;

    /**
     * Estado de la lecciÃ³n para el usuario actual.
     * Por ahora siempre serÃ¡ "ACTIVE" (Fase 1).
     * En Fase 4 se calcularÃ¡ segÃºn el progreso.
     */
    private String status;        // "LOCKED", "ACTIVE", "COMPLETE"
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/model/Module.java
================================================================================

package com.bughuntersaga.api.domain.model;

import lombok.*;

import java.util.Map;


/**
 * Entidad de dominio Module.
 * POJO puro sin dependencias de frameworks.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Module {
    private Integer id;
    private String code;
    private String name;
    private String description;
    private Map<String, Object> uiConfig;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/Problem.java
================================================================================

package com.bughuntersaga.api.domain.model;

import lombok.*;

import java.util.List;


/**
 * Entidad de dominio Problem.
 * Contiene campos especÃ­ficos segÃºn el tipo de problema.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class Problem {

    private String type;

    // Campos para tipo INFO
    private String moduleTitle;
    private String introduction;
    private List<String> objectives;

    // Campos para preguntas
    private String question;

    // Campos para SELECT_1_OF_3
    private List<AnswerOption> answers;
    private Integer correctAnswer;

    // Campos para FILL_IN_THE_BLANK
    private List<String> answerTiles;
    private List<Integer> correctAnswerIndices;

    /**
     * OpciÃ³n de respuesta.
     */
    @Getter
    @Setter
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class AnswerOption {
        private String name;
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/ShopItem.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ShopItem {
    private Integer id;
    private String itemCode;
    private String name;
    private String description;
    private Integer cost;
    private String icon;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/Unit.java
================================================================================

package com.bughuntersaga.api.domain.model;

import lombok.*;

import java.util.List;


@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Unit {
    private Integer id;
    private Integer unitNumber;
    private String description;
    private List<Lesson> lessons;
}


================================================================================
ğŸ“„ CONTENIDO DE: domain/model/User.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.*;
import java.time.LocalDateTime;
import java.time.ZonedDateTime; // Importar
import java.util.UUID;


@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class User {
    private UUID id;
    private String username;
    private String email;
    private String passwordHash;
    private String name;
    private String lastname;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private String passwordResetToken;
    private ZonedDateTime passwordResetExpires;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/UserInventory.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.ZonedDateTime;
import java.util.UUID;

/**
 * Entidad de dominio que representa un artÃ­culo en el inventario de un usuario.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserInventory {
    private Long id;
    private UUID userId;
    private String itemCode;
    private Integer quantity;
    private ZonedDateTime createdAt;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/UserLessonProgress.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.ZonedDateTime;
import java.util.UUID;

/**
 * Entidad de dominio que representa el progreso de un usuario en una lecciÃ³n.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserLessonProgress {
    private UUID userId;
    private Integer lessonId;
    private ZonedDateTime completedAt;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/UserProfile.java
================================================================================

package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.util.UUID;

/**
 * Entidad de dominio UserProfile.
 *
 * Representa el perfil de un usuario con su informaciÃ³n de progreso.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserProfile {
    private UUID userId;
    private Integer lingots;
    private Integer dailyXpGoal;
    private Boolean soundEffectsEnabled;
    private Integer currentModuleId;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/UserStreak.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.LocalDate;
import java.util.UUID;

/**
 * Entidad de dominio que representa un dÃ­a de actividad para un usuario.
 * La 'racha' es el cÃ¡lculo de dÃ­as consecutivos de esta tabla.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserStreak {
    private UUID userId;
    private LocalDate activityDate;
}

================================================================================
ğŸ“„ CONTENIDO DE: domain/model/UserXpHistory.java
================================================================================
package com.bughuntersaga.api.domain.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

import java.time.ZonedDateTime;
import java.util.UUID;

/**
 * Entidad de dominio que representa un evento donde un usuario ganÃ³ XP.
 */
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserXpHistory {
    private Long id;
    private UUID userId;
    private Integer xpEarned;
    private String sourceType; // "LESSON", "TREASURE", "CHALLENGE"
    private Integer sourceId; // e.g., lessonId
    private ZonedDateTime createdAt;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/adapters/email/ConsoleEmailSenderAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.adapters.email;

import com.bughuntersaga.api.application.port.out.EmailSenderPort;
import com.bughuntersaga.api.domain.model.User;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * Adaptador de Email "Simulado" (Mock/Stub).
 * En lugar de enviar un email real, imprime el enlace en la consola.
 * Perfecto para desarrollo y pruebas.
 */
@Component
@Slf4j
public class ConsoleEmailSenderAdapter implements EmailSenderPort {

    @Override
    public void sendPasswordResetEmail(User user, String token, String resetUrlBase) {
        String resetLink = resetUrlBase + "?token=" + token;

        log.info("==================================================");
        log.info("===== SIMULACIÃ“N DE ENVÃO DE EMAIL =====");
        log.info("Para: {}", user.getEmail());
        log.info("Asunto: Resetea tu contraseÃ±a de BugHunter Saga");
        log.info("Cuerpo: Â¡Hola, {}! Para resetear tu contraseÃ±a, haz clic en este enlace:", user.getName());
        log.info("Enlace: {}", resetLink);
        log.info("==================================================");
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/config/BeanConfiguration.java
================================================================================
package com.bughuntersaga.api.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import java.time.Clock;

@Configuration
public class BeanConfiguration {


    @Bean
    public Clock clock() {
        return Clock.systemUTC();
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/config/OpenAPIConfig.java
================================================================================
package com.bughuntersaga.api.infrastructure.config;

import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.servers.Server;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.Components;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class OpenAPIConfig {

    @Bean
    public OpenAPI bugHunterOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("BugHunter Saga API")
                        .description("""
                            API (Contrato Primero) para la plataforma gamificada BugHunter Saga.
                            DiseÃ±ada para soportar la implementaciÃ³n del frontend en Next.js
                            y el backend en Spring Boot para el proyecto de tesis de Max CarriÃ³n.
                            """)
                        .version("1.0.0")
                        .contact(new Contact()
                                .name("Max CarriÃ³n")
                                .email("max.carrion@epn.edu.ec")))
                .servers(List.of(
                        new Server()
                                .url("http://localhost:8080")
                                .description("Servidor de desarrollo"),
                        new Server()
                                .url("/api")
                                .description("Prefijo base de la API")))
                .components(new Components()
                        .addSecuritySchemes("bearerAuth", new SecurityScheme()
                                .type(SecurityScheme.Type.HTTP)
                                .scheme("bearer")
                                .bearerFormat("JWT")
                                .description("Ingresa tu token JWT aquÃ­")))
                .addSecurityItem(new SecurityRequirement().addList("bearerAuth"));
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/LeaderboardRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.LeaderboardData;
import com.bughuntersaga.api.application.port.out.LeaderboardRepositoryPort;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserXpHistoryJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.projections.LeaderboardProjection;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.time.ZonedDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Repository
@RequiredArgsConstructor
public class LeaderboardRepositoryAdapter implements LeaderboardRepositoryPort {

    private final UserXpHistoryJpaRepository userXpHistoryRepository;

    @Override
    public List<LeaderboardData> findLeaderboardData(ZonedDateTime start, ZonedDateTime end) {

        List<LeaderboardProjection> projections = userXpHistoryRepository
                .findLeaderboardForWeek(start, end);


        return projections.stream()
                .map(p -> new LeaderboardData(
                        p.getUserId(),
                        p.getName(),
                        p.getTotalXp()
                ))
                .collect(Collectors.toList());
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/LessonRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.LessonRepositoryPort;
import com.bughuntersaga.api.domain.model.Lesson;
import com.bughuntersaga.api.infrastructure.persistence.mapper.ContentPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.LessonJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Repository
@RequiredArgsConstructor
public class LessonRepositoryAdapter implements LessonRepositoryPort {

    private final LessonJpaRepository lessonJpaRepository;
    private final ContentPersistenceMapper contentMapper;

    @Override
    public Optional<Lesson> findById(Integer id) {
        return lessonJpaRepository.findById(id)
                .map(contentMapper::lessonToDomain);
    }

    @Override
    public List<Lesson> findByUnitId(Integer unitId) {
        return lessonJpaRepository.findByUnitIdOrderByPositionAsc(unitId).stream()
                .map(contentMapper::lessonToDomain)
                .collect(Collectors.toList());
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/ModuleRepositoryAdapter.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.domain.model.Module;
import com.bughuntersaga.api.infrastructure.persistence.mapper.ContentPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.ModuleJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;
import com.bughuntersaga.api.application.port.out.ModuleRepositoryPort;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;


@Repository
@RequiredArgsConstructor
public class ModuleRepositoryAdapter implements ModuleRepositoryPort {

    private final ModuleJpaRepository moduleJpaRepository;
    private final ContentPersistenceMapper contentMapper;

    @Override
    public List<Module> findAll() {
        return moduleJpaRepository.findAll().stream().map(contentMapper::moduleToDomain)
                .collect(Collectors.toList());
    }

    @Override
    public Optional<Module> findById(Integer id) {
        return moduleJpaRepository.findById(id).map(contentMapper::moduleToDomain);
    }

    @Override
    public Optional<Module> findByCode(String code) {
        return moduleJpaRepository.findByCode(code).map(contentMapper::moduleToDomain);
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/ProblemRepositoryAdapter.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.ProblemRepositoryPort;
import com.bughuntersaga.api.domain.model.Problem;
import com.bughuntersaga.api.infrastructure.persistence.mapper.ContentPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.ProblemJpaRepository;
import com.bughuntersaga.api.infrastructure.web.mapper.ContentApiMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Adaptador de persistencia para problemas.
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class ProblemRepositoryAdapter implements ProblemRepositoryPort {

    private final ProblemJpaRepository jpaRepository;
    private final ContentPersistenceMapper mapper;

    @Override
    public List<Problem> findProblemsByModuleCode(String moduleCode) {
        return jpaRepository.findProblemsByModuleCode(moduleCode).stream()
                .map(mapper::problemToDomain)
                .collect(Collectors.toList());
    }

    @Override
    public Optional<Problem> findById(Integer id) {
        return jpaRepository.findById(id).map(mapper::problemToDomain);
    }

    @Override
    public List<Problem> findByLessonId(Integer lessonId) {
        return jpaRepository.findByLessonIdOrderByPositionAsc(lessonId).stream()
                .map(mapper::problemToDomain)
                .collect(Collectors.toList());
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/ShopItemRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.ShopItemRepositoryPort;
import com.bughuntersaga.api.domain.model.ShopItem;
import com.bughuntersaga.api.infrastructure.persistence.mapper.GamificationPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.ShopItemJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

@Repository
@RequiredArgsConstructor
public class ShopItemRepositoryAdapter implements ShopItemRepositoryPort {

    private final ShopItemJpaRepository jpaRepository;
    private final GamificationPersistenceMapper mapper;

    @Override
    public List<ShopItem> findAll() {
        return jpaRepository.findAll().stream()
                .map(mapper::toDomain)
                .collect(Collectors.toList());
    }

    @Override
    public Optional<ShopItem> findByItemCode(String itemCode) {
        return jpaRepository.findByItemCode(itemCode)
                .map(mapper::toDomain);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UnitRepositoryAdapter.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UnitRepositoryPort;
import com.bughuntersaga.api.domain.model.Lesson;
import com.bughuntersaga.api.domain.model.Unit;
import com.bughuntersaga.api.infrastructure.persistence.entity.LessonEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UnitEntity;
import com.bughuntersaga.api.infrastructure.persistence.mapper.ContentPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.LessonJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UnitJpaRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Adaptador de persistencia para unidades.
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class UnitRepositoryAdapter implements UnitRepositoryPort {

    private final UnitJpaRepository unitJpaRepository;
    private final LessonJpaRepository lessonJpaRepository;
    private final ContentPersistenceMapper mapper;

    @Override
    public Optional<Unit> findFirstUnitByModuleCode(String moduleCode) {
        return unitJpaRepository.findByModuleCodeOrderByUnitNumber(moduleCode).stream()
                .findFirst()
                .map(this::mapUnitWithLessons);
    }

    @Override
    public List<Unit> findUnitsByModuleCode(String moduleCode) {

        return unitJpaRepository.findByModuleCode(moduleCode).stream()
                .map(this::mapUnitWithLessons)
                .collect(Collectors.toList());
    }

    @Override
    public Optional<Unit> findByIdWithLessons(Integer unitId) {

        return unitJpaRepository.findById(unitId)
                .map(this::mapUnitWithLessons);
    }

    /**
     * Mapea UnitEntity a Unit y carga sus lecciones.
     */
    private Unit mapUnitWithLessons(UnitEntity unitEntity) {
        // Mapear unidad
        Unit unit = mapper.unitToDomain(unitEntity);

        // Cargar lecciones
        List<LessonEntity> lessonEntities = lessonJpaRepository
                .findByUnitIdOrderByPositionAsc(unitEntity.getId());

        List<Lesson> lessons = lessonEntities.stream()
                .map(mapper::lessonToDomain)
                .collect(Collectors.toList());

        unit.setLessons(lessons);

        return unit;
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserInventoryRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserInventoryRepositoryPort;
import com.bughuntersaga.api.domain.model.UserInventory;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserInventoryEntity;
import com.bughuntersaga.api.infrastructure.persistence.mapper.GamificationPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserInventoryJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

@Repository
@RequiredArgsConstructor
public class UserInventoryRepositoryAdapter implements UserInventoryRepositoryPort {

    private final UserInventoryJpaRepository jpaRepository;
    private final UserJpaRepository userJpaRepository; // Necesario para la relaciÃ³n
    private final GamificationPersistenceMapper mapper;

    @Override
    public Optional<UserInventory> findByUserIdAndItemCode(UUID userId, String itemCode) {
        return jpaRepository.findByUserIdAndItemCode(userId, itemCode)
                .map(mapper::toDomain);
    }

    @Override
    public UserInventory save(UserInventory inventory) {
        // Mapear de Dominio a Entidad
        UserInventoryEntity entity = jpaRepository.findById(inventory.getId() != null ? inventory.getId() : -1)
                .orElse(mapper.toEntity(inventory));

        // Asignar los campos mapeados
        entity.setQuantity(inventory.getQuantity());
        entity.setItemCode(inventory.getItemCode());

        // Adjuntar la entidad de usuario (requerido por el @ManyToOne)
        if (entity.getUser() == null) {
            UserEntity userEntity = userJpaRepository.findById(inventory.getUserId())
                    .orElseThrow(() -> new RuntimeException("Usuario no encontrado al guardar inventario: " + inventory.getUserId()));
            entity.setUser(userEntity);
        }

        // Guardar la entidad
        UserInventoryEntity savedEntity = jpaRepository.save(entity);

        // Mapear de vuelta a Dominio
        return mapper.toDomain(savedEntity);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserLessonProgressRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserLessonProgressRepositoryPort;
import com.bughuntersaga.api.domain.model.UserLessonProgress;
import com.bughuntersaga.api.infrastructure.persistence.entity.LessonEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserLessonProgressEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserLessonProgressId;
import com.bughuntersaga.api.infrastructure.persistence.mapper.ProgressPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.LessonJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserLessonProgressJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.Set;
import java.util.UUID;

@Repository
@RequiredArgsConstructor
public class UserLessonProgressRepositoryAdapter implements UserLessonProgressRepositoryPort {

    private final UserLessonProgressJpaRepository jpaRepository;
    private final UserJpaRepository userJpaRepository;
    private final LessonJpaRepository lessonJpaRepository;
    private final ProgressPersistenceMapper mapper;

    @Override
    public Set<Integer> findCompletedLessonIdsByUserId(UUID userId) {
        return jpaRepository.findCompletedLessonIdsByUserId(userId);
    }

    @Override
    public boolean existsByUserIdAndLessonId(UUID userId, Integer lessonId) {
        return jpaRepository.existsById_UserIdAndId_LessonId(userId, lessonId);
    }

    @Override
    public UserLessonProgress save(UserLessonProgress progress) {
        // Para manejar @MapsId correctamente, debemos cargar las entidades padre
        UserEntity userEntity = userJpaRepository.findById(progress.getUserId())
                .orElseThrow(() -> new RuntimeException("Usuario no encontrado para guardar progreso: " + progress.getUserId()));

        LessonEntity lessonEntity = lessonJpaRepository.findById(progress.getLessonId())
                .orElseThrow(() -> new RuntimeException("LecciÃ³n no encontrada para guardar progreso: " + progress.getLessonId()));

        // Construimos la entidad
        UserLessonProgressEntity entity = new UserLessonProgressEntity();
        entity.setId(new UserLessonProgressId(progress.getUserId(), progress.getLessonId()));
        entity.setUser(userEntity);
        entity.setLesson(lessonEntity);
        entity.setCompletedAt(progress.getCompletedAt()); // O ZonedDateTime.now() si se prefiere

        UserLessonProgressEntity savedEntity = jpaRepository.save(entity);

        // Devolvemos el modelo de dominio
        return mapper.toDomain(savedEntity);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserProfileRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserProfileRepositoryPort;
import com.bughuntersaga.api.domain.model.UserProfile;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserProfileEntity;
import com.bughuntersaga.api.infrastructure.persistence.mapper.UserPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserProfileJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

@Repository
@RequiredArgsConstructor
public class UserProfileRepositoryAdapter implements UserProfileRepositoryPort {

    private final UserProfileJpaRepository userProfileJpaRepository;
    private final UserPersistenceMapper userPersistenceMapper;


    private final UserJpaRepository userJpaRepository;

    @Override
    public UserProfile save(UserProfile userProfile) {

        UserProfileEntity entity = userProfileJpaRepository.findById(userProfile.getUserId())
                .orElse(userPersistenceMapper.toUserProfileEntity(userProfile));

        // Mapear campos simples
        entity.setLingots(userProfile.getLingots());
        entity.setDailyXpGoal(userProfile.getDailyXpGoal());
        entity.setSoundEffectsEnabled(userProfile.getSoundEffectsEnabled());

        // Manejar relaciones
        if (entity.getUser() == null) {
            UserEntity userEntity = userJpaRepository.findById(userProfile.getUserId())
                    .orElseThrow(() -> new RuntimeException("Usuario no encontrado al crear perfil: " + userProfile.getUserId()));
            entity.setUser(userEntity);
        }


        UserProfileEntity savedEntity = userProfileJpaRepository.save(entity);
        return userPersistenceMapper.toUserProfileDomain(savedEntity);
    }

    @Override
    public Optional<UserProfile> findById(UUID userId) {
        return userProfileJpaRepository.findById(userId)
                .map(userPersistenceMapper::toUserProfileDomain);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserRepositoryPort;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.mapper.UserPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

@Repository
@RequiredArgsConstructor
public class UserRepositoryAdapter implements UserRepositoryPort {

    // Depende de implementaciones de persistencia
    private final UserJpaRepository userJpaRepository;
    private final UserPersistenceMapper userPersistenceMapper;

    @Override
    public User save(User user) {
        // Mapea de Dominio a Entidad
        UserEntity userEntity = userPersistenceMapper.toUserEntity(user);
        // Guarda la Entidad
        UserEntity savedEntity = userJpaRepository.save(userEntity);
        // Mapea de Entidad a Dominio
        return userPersistenceMapper.toUserDomain(savedEntity);
    }

    @Override
    public Optional<User> findByUsername(String username) {
        return userJpaRepository.findByUsername(username)
                .map(userPersistenceMapper::toUserDomain);
    }

    @Override
    public Optional<User> findByEmail(String email) {
        return userJpaRepository.findByEmail(email)
                .map(userPersistenceMapper::toUserDomain);
    }

    @Override
    public Optional<User> findByUsernameOrEmail(String username, String email) {
        return userJpaRepository.findByUsernameOrEmail(username, email)
                .map(userPersistenceMapper::toUserDomain);
    }
    @Override
    public boolean existsByUsernameAndIdNot(String username, UUID userId) {
        return userJpaRepository.existsByUsernameAndIdNot(username, userId);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserStreakRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserStreakRepositoryPort;
import com.bughuntersaga.api.domain.model.UserStreak;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserStreakEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserStreakId;
import com.bughuntersaga.api.infrastructure.persistence.mapper.GamificationPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserStreakJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.Set;
import java.util.UUID;

@Repository
@RequiredArgsConstructor
public class UserStreakRepositoryAdapter implements UserStreakRepositoryPort {

    private final UserStreakJpaRepository jpaRepository;
    private final UserJpaRepository userJpaRepository;
    private final GamificationPersistenceMapper mapper;

    @Override
    public UserStreak save(UserStreak streak) {

        UserEntity userEntity = userJpaRepository.findById(streak.getUserId())
                .orElseThrow(() -> new RuntimeException("Usuario no encontrado al guardar racha: " + streak.getUserId()));


        UserStreakEntity entity = new UserStreakEntity();
        entity.setId(new UserStreakId(streak.getUserId(), streak.getActivityDate()));
        entity.setUser(userEntity);

        UserStreakEntity savedEntity = jpaRepository.save(entity);
        return mapper.toDomain(savedEntity);
    }

    @Override
    public Set<LocalDate> findAllActivityDatesByUserId(UUID userId) {
        return jpaRepository.findAllActivityDatesByUserId(userId);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/adapter/UserXpHistoryRepositoryAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.adapter;

import com.bughuntersaga.api.application.port.out.UserXpHistoryRepositoryPort;
import com.bughuntersaga.api.domain.model.UserXpHistory;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserXpHistoryEntity;
import com.bughuntersaga.api.infrastructure.persistence.mapper.GamificationPersistenceMapper;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserJpaRepository;
import com.bughuntersaga.api.infrastructure.persistence.repository.UserXpHistoryJpaRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Repository;
import java.time.ZonedDateTime;
import java.util.UUID;

@Repository
@RequiredArgsConstructor

public class UserXpHistoryRepositoryAdapter implements UserXpHistoryRepositoryPort {

    private final UserXpHistoryJpaRepository jpaRepository;
    private final UserJpaRepository userJpaRepository;
    private final GamificationPersistenceMapper mapper;

    @Override
    public UserXpHistory save(UserXpHistory history) {

        UserXpHistoryEntity entity = mapper.toEntity(history);
        UserEntity userEntity = userJpaRepository.findById(history.getUserId())
                .orElseThrow(() -> new RuntimeException("Usuario no encontrado al guardar XP: " + history.getUserId()));
        entity.setUser(userEntity);
        entity.setCreatedAt(history.getCreatedAt());
        UserXpHistoryEntity savedEntity = jpaRepository.save(entity);
        return mapper.toDomain(savedEntity);
    }

    @Override
    public int sumTotalXpByUserId(UUID userId) {
        return jpaRepository.sumTotalXpByUserId(userId);
    }

    @Override
    public int sumXpEarnedBetween(UUID userId, ZonedDateTime start, ZonedDateTime end) {
        return jpaRepository.sumXpEarnedBetween(userId, start, end);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/LeagueEntity.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "leagues")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class LeagueEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "name", nullable = false, length = 50, unique = true)
    private String name;

    @Column(name = "min_xp", nullable = false)
    private Integer minXp;

    @Column(name = "max_xp")
    private Integer maxXp;

    @Column(name = "icon", length = 50)
    private String icon;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/LessonEntity.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;
/**
 * Entidad JPA para la tabla 'lessons'.
 */
@Entity
@Table(name = "lessons")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class LessonEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(name = "unit_id", nullable = false)
    private Integer unitId;

    @Column(nullable = false, length = 50)
    private String type;

    @Column(columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private Integer position;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/ModuleEntity.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.util.Map;

/**
 * Entidad JPA para la tabla 'modules'.
 *
 * Representa un mÃ³dulo de aprendizaje (ej. MÃ³dulo A - Equivalencia).
 */
@Entity
@Table(name = "modules")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ModuleEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "code", unique = true, nullable = false, length = 20)
    private String code;

    @Column(name = "name", nullable = false, length = 100)
    private String name;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    /**
     * ConfiguraciÃ³n de UI en formato JSON.
     * Ejemplo: {"backgroundColor": "bg-blue-500", "icon": "ğŸ¯"}
     */
    @JdbcTypeCode(SqlTypes.JSON)
    @Column(name = "ui_config", columnDefinition = "jsonb")
    private Map<String, Object> uiConfig;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/ProblemEntity.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.JdbcTypeCode;
import org.hibernate.type.SqlTypes;

import java.util.Map;

/**
 * Entidad JPA para la tabla 'problems'.
 */
@Entity
@Table(name = "problems")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProblemEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(name = "lesson_id", nullable = false)
    private Integer lessonId;

    @Column(nullable = false, length = 50)
    private String type;

    @JdbcTypeCode(SqlTypes.JSON)
    @Column(nullable = false, columnDefinition = "jsonb")
    private Map<String, Object> content;

    @Column(nullable = false)
    private Integer position;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/ShopItemEntity.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;

@Entity
@Table(name = "shop_items")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
public class ShopItemEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "item_code", nullable = false, unique = true, length = 50)
    private String itemCode;

    @Column(name = "name", nullable = false, length = 100)
    private String name;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "cost", nullable = false)
    private Integer cost;

    @Column(name = "icon", length = 50)
    private String icon;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UnitEntity.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;

/**
 * Entidad JPA para la tabla 'units'.
 *
 * Representa una unidad dentro de un mÃ³dulo.
 */
@Entity
@Table(name = "units")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UnitEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "id")
    private Integer id;

    @Column(name = "module_id", nullable = false)
    private Integer moduleId;

    @Column(name = "unit_number", nullable = false)
    private Integer unitNumber;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserEntity.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;

import java.time.ZonedDateTime;
import java.util.UUID;
import java.time.LocalDateTime;

@Entity
@Table(name = "users", uniqueConstraints = {
        @UniqueConstraint(columnNames = "username"),
        @UniqueConstraint(columnNames = "email")
})
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.UUID)
    private UUID id;

    @Column(unique = true, nullable = false, length = 50)
    private String username; // <--- CAMPO AÃ‘ADIDO

    @Column(unique = true, nullable = false)
    private String email;

    @Column(name = "password_hash", nullable = false)
    private String passwordHash;

    @Column(nullable = false, length = 100)
    private String name;

    @Column(length = 100)
    private String lastname;

    @Column(name = "created_at", updatable = false, nullable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @Column(name = "password_reset_token", length = 255)
    private String passwordResetToken;

    @Column(name = "password_reset_expires", columnDefinition = "timestamptz")
    private ZonedDateTime passwordResetExpires;

    @OneToOne(mappedBy = "user", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
    private UserProfileEntity userProfile;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserInventoryEntity.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.CreationTimestamp;

import java.time.ZonedDateTime;
import java.util.UUID;

@Entity
@Table(name = "user_inventory", uniqueConstraints = {
        @UniqueConstraint(columnNames = {"user_id", "item_code"})
})
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UserInventoryEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private UserEntity user;

    @Column(name = "item_code", nullable = false, length = 50)
    private String itemCode;

    @Column(nullable = false)
    private Integer quantity;

    @CreationTimestamp
    @Column(name = "created_at", updatable = false, columnDefinition = "timestamptz DEFAULT (now())")
    private ZonedDateTime createdAt;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserLessonProgressEntity.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

    import jakarta.persistence.*;
import lombok.*;
import java.time.ZonedDateTime;


    @Entity
@Table(name = "user_lesson_progress")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
    public class UserLessonProgressEntity {

    @EmbeddedId
    private UserLessonProgressId id;

    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("userId")
    @JoinColumn(name = "user_id")
    private UserEntity user;

    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("lessonId")
    @JoinColumn(name = "lesson_id")
    private LessonEntity lesson;

    @Column(name = "completed_at", columnDefinition = "timestamptz DEFAULT (now())")
    private ZonedDateTime completedAt;

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserLessonProgressId.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

    import jakarta.persistence.Embeddable;
import lombok.*;
import java.io.Serializable;
import java.util.UUID;


    @Embeddable
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode
    public class UserLessonProgressId implements Serializable {

    private UUID userId;
    private Integer lessonId;

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserProfileEntity.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

    import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;


    @Entity
@Table(name = "user_profiles")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
    public class UserProfileEntity {

    @Id
    @Column(name = "user_id")
    private UUID userId;

    @OneToOne(fetch = FetchType.LAZY)
    @MapsId
    @JoinColumn(name = "user_id")
    private UserEntity user;

    @Column(nullable = false)
    private Integer lingots;

    @Column(name = "daily_xp_goal", nullable = false)
    private Integer dailyXpGoal;

    @Column(name = "sound_effects_enabled", nullable = false)
    private Boolean soundEffectsEnabled;


    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserStreakEntity.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

    import jakarta.persistence.*;
import lombok.*;


    @Entity
@Table(name = "user_streaks")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
    public class UserStreakEntity {

    @EmbeddedId
    private UserStreakId id;

    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("userId")
    @JoinColumn(name = "user_id")
    private UserEntity user;

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserStreakId.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

import jakarta.persistence.Embeddable;
import lombok.*;
import java.io.Serializable;
import java.util.UUID;
import java.time.LocalDate;


    @Embeddable
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@EqualsAndHashCode
    public class UserStreakId implements Serializable {

    private UUID userId;
    private LocalDate activityDate;

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/entity/UserXpHistoryEntity.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.entity;

    import jakarta.persistence.*;
import lombok.*;
import java.util.UUID;
import java.time.ZonedDateTime;


    @Entity
@Table(name = "user_xp_history")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
    public class UserXpHistoryEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private UserEntity user;

    @Column(name = "xp_earned", nullable = false)
    private Integer xpEarned;

    @Column(name = "source_type", length = 50)
    private String sourceType;

    @Column(name = "source_id")
    private Integer sourceId;

    @Column(name = "created_at", columnDefinition = "timestamptz DEFAULT (now())")
    private ZonedDateTime createdAt;

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/mapper/ContentPersistenceMapper.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.mapper;
import com.bughuntersaga.api.domain.model.Lesson;
import com.bughuntersaga.api.domain.model.Module;
import com.bughuntersaga.api.domain.model.Problem;
import com.bughuntersaga.api.domain.model.Unit;
import com.bughuntersaga.api.infrastructure.persistence.entity.LessonEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.ModuleEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.ProblemEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UnitEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * Mapper consolidado para entidades de persistencia de Content.
 *
 * Usa nombres ESPECÃFICOS para evitar ambigÃ¼edad:
 * - moduleToDomain() / moduleToEntity() â† Para Module
 * - problemToDomain() / problemToEntity() â† Para Problem
 *
 * ConfiguraciÃ³n:
 * - componentModel = "spring": Genera bean de Spring
 * - unmappedTargetPolicy = IGNORE: Ignora campos sin mapear
 */
@Mapper(
        componentModel = "spring",
        unmappedTargetPolicy = ReportingPolicy.IGNORE
)
public interface ContentPersistenceMapper {

    // ========================================
    // Mapeo de Module (AutomÃ¡tico)
    // ========================================

    /**
     * Convierte ModuleEntity â†’ Module.
     * MapStruct genera el cÃ³digo automÃ¡ticamente.
     */
    Module moduleToDomain(ModuleEntity moduleEntity);

    /**
     * Convierte Module â†’ ModuleEntity.
     * MapStruct genera el cÃ³digo automÃ¡ticamente.
     */
    ModuleEntity moduleToEntity(Module module);


    // ========================================
    // Mapeo de Unit
    // ========================================

    /**
     * Convierte UnitEntity â†’ Unit.
     *
     * NOTA: El campo 'lessons' no se mapea automÃ¡ticamente.
     * Se debe cargar y asignar manualmente en el adaptador.
     */
    @Mapping(target = "lessons", ignore = true)
    Unit unitToDomain(UnitEntity entity);

    UnitEntity unitToEntity(Unit domain);

    // ========================================
    // Mapeo de Lesson
    // ========================================

    /**
     * Convierte LessonEntity â†’ Lesson.
     *
     * NOTA: El campo 'status' no existe en la BD.
     * Se debe asignar manualmente segÃºn la lÃ³gica de negocio.
     */
    @Mapping(target = "status", ignore = true)
    Lesson lessonToDomain(LessonEntity entity);

    LessonEntity lessonToEntity(Lesson domain);


    // ========================================
    // Mapeo de Problem
    // ========================================

    default Problem problemToDomain(ProblemEntity entity) {
        if (entity == null) return null;

        Problem.ProblemBuilder builder = Problem.builder()
                .type(entity.getType());

        Map<String, Object> content = entity.getContent();
        if (content == null) return builder.build();

        // Extraer campos comunes primero (como 'question')
        builder.question((String) content.get("question"));

        // Extraer campos especÃ­ficos del tipo
        switch (entity.getType()) {
            case "INFO" -> mapInfoType(builder, content);
            case "SELECT_1_OF_3" -> mapSelectType(builder, content);
            case "FILL_IN_THE_BLANK" -> mapFillInBlankType(builder, content);
        }

        return builder.build();
    }

    // ... (problemToEntity estÃ¡ bien) ...

    // ========================================
    // MÃ©todos Auxiliares (Corregidos)
    // ========================================

    /**
     * Mapea campos para tipo INFO.
     * CORREGIDO: Extrae: title, content
     */
    @SuppressWarnings("unchecked")
    default void mapInfoType(Problem.ProblemBuilder builder, Map<String, Object> content) {
        // Tu SQL usa 'title', no 'moduleTitle' en el problema
        builder.introduction((String) content.get("title"));

        // AquÃ­ puedes decidir cÃ³mo mapear 'content' y 'example'
        // Por ejemplo, podrÃ­as concatenarlos o usar 'introduction' para 'content'
        // Asumamos que 'introduction' en el dominio es el 'title' de la BD
        // y 'moduleTitle' es el 'content' de la BD.
        builder.moduleTitle((String) content.get("content"));

        // 'objectives' no existe en tu SQL.
    }

    /**
     * Mapea campos para tipo SELECT_1_OF_3.
     * CORREGIDO: Extrae: question, options (como answers), correctAnswer
     */
    @SuppressWarnings("unchecked")
    default void mapSelectType(Problem.ProblemBuilder builder, Map<String, Object> content) {
        // 'question' ya se mapea arriba

        // CORREGIDO: Tu SQL usa "options", no "answers"
        Object answersObj = content.get("options");
        if (answersObj instanceof List) {
            List<Map<String, Object>> answersRaw = (List<Map<String, Object>>) answersObj;
            List<Problem.AnswerOption> answers = answersRaw.stream()
                    .map(map -> Problem.AnswerOption.builder()
                            // CORREGIDO: Tu SQL usa "text", no "name"
                            .name((String) map.get("text"))
                            .build())
                    .collect(Collectors.toList());
            builder.answers(answers);
        }

        // Mapear respuesta correcta
        // Tu SQL la tiene como String ("b"), pero tu dominio la espera como Integer.
        // AquÃ­ necesitarÃ¡s una lÃ³gica para convertir "a"->0, "b"->1, "c"->2
        Object correctAnswer = content.get("correctAnswer");
        if (correctAnswer instanceof String) {
            switch ((String) correctAnswer) {
                case "a" -> builder.correctAnswer(0);
                case "b" -> builder.correctAnswer(1);
                case "c" -> builder.correctAnswer(2);
                // AÃ±ade mÃ¡s casos si es necesario
            }
        }
    }

    /**
     * Mapea campos para tipo FILL_IN_THE_BLANK.
     * CORREGIDO: Extrae: question, blanks, correctAnswers
     */
    @SuppressWarnings("unchecked")
    default void mapFillInBlankType(Problem.ProblemBuilder builder, Map<String, Object> content) {
        // 'question' ya se mapea arriba

        // CORREGIDO: Tu SQL usa "blanks", no "answerTiles"
        Object answerTiles = content.get("blanks");
        if (answerTiles instanceof List) {
            builder.answerTiles((List<String>) answerTiles);
        }

        // CORREGIDO: Tu SQL usa "correctAnswers" (lista de Strings)
        // pero tu dominio espera "correctAnswerIndices" (lista de Integers)
        // Por ahora, asumirÃ© que "correctAnswers" de tu SQL *deberÃ­a*
        // haber sido "correctAnswerIndices" con nÃºmeros.
        // Si no, la lÃ³gica de conversiÃ³n es mÃ¡s compleja.
        Object correctIndices = content.get("correctAnswerIndices"); // Asumiendo que cambias el SQL
        if (correctIndices instanceof List) {
            List<Integer> indices = ((List<?>) correctIndices).stream()
                    .filter(obj -> obj instanceof Number)
                    .map(obj -> ((Number) obj).intValue())
                    .collect(Collectors.toList());
            builder.correctAnswerIndices(indices);
        }
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/mapper/GamificationPersistenceMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.mapper;

import com.bughuntersaga.api.domain.model.UserStreak;
import com.bughuntersaga.api.domain.model.UserXpHistory;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserStreakEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserXpHistoryEntity;
import com.bughuntersaga.api.domain.model.ShopItem;
import com.bughuntersaga.api.infrastructure.persistence.entity.ShopItemEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;
import com.bughuntersaga.api.domain.model.UserInventory;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserInventoryEntity;


@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface GamificationPersistenceMapper {

    // --- UserXpHistory ---
    @Mapping(source = "user.id", target = "userId")
    UserXpHistory toDomain(UserXpHistoryEntity entity);

    @Mapping(target = "user", ignore = true)
    UserXpHistoryEntity toEntity(UserXpHistory domain);

    // --- UserStreak ---
    @Mapping(source = "id.userId", target = "userId")
    @Mapping(source = "id.activityDate", target = "activityDate")
    UserStreak toDomain(UserStreakEntity entity);

    ShopItem toDomain(ShopItemEntity entity);
    ShopItemEntity toEntity(ShopItem domain);

    // --- UserInventory (NUEVO) ---
    @Mapping(source = "user.id", target = "userId")
    UserInventory toDomain(UserInventoryEntity entity);

    @Mapping(target = "user", ignore = true) // El adaptador se encarga de las relaciones
    UserInventoryEntity toEntity(UserInventory domain);

}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/mapper/ProgressPersistenceMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.mapper;

import com.bughuntersaga.api.domain.model.UserLessonProgress;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserLessonProgressEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface ProgressPersistenceMapper {

    /**
     * Mapea de Entidad (JPA) a Dominio.
     * Maneja la clave compuesta @EmbeddedId.
     */
    @Mapping(source = "id.userId", target = "userId")
    @Mapping(source = "id.lessonId", target = "lessonId")
    UserLessonProgress toDomain(UserLessonProgressEntity entity);


}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/mapper/UserPersistenceMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.mapper;

import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.domain.model.UserProfile;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserProfileEntity;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserPersistenceMapper {


    UserEntity toUserEntity(User user);
    User toUserDomain(UserEntity userEntity);

    @Mapping(source = "userId", target = "userId")
    UserProfile toUserProfileDomain(UserProfileEntity entity);

    @Mapping(target = "userId", ignore = true)
    @Mapping(target = "user", ignore = true)
    UserProfileEntity toUserProfileEntity(UserProfile domain);



}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/LessonJpaRepository.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.LessonEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;


@Repository
public interface LessonJpaRepository extends JpaRepository<LessonEntity, Integer> {
    /**
     * Obtiene todas las lecciones de una unidad.
     *
     * @param unitId ID de la unidad
     * @return Lista de lecciones ordenadas por posiciÃ³n
     */
    @Query("""
        SELECT l 
        FROM LessonEntity l
        WHERE l.unitId = :unitId
        ORDER BY l.position ASC
        """)
    List<LessonEntity> findByUnitIdOrderByPositionAsc(@Param("unitId") Integer unitId);

}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/ModuleJpaRepository.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.ModuleEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;


@Repository
public interface ModuleJpaRepository extends JpaRepository<ModuleEntity, Integer> {
    /**
     * Busca un mÃ³dulo por su cÃ³digo Ãºnico.
     *
     * @param code CÃ³digo del mÃ³dulo (ej. "mod-a")
     * @return Optional con la entidad si existe
     */
    Optional<ModuleEntity> findByCode(String code);
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/ProblemJpaRepository.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.ProblemEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;


@Repository
public interface ProblemJpaRepository extends JpaRepository<ProblemEntity, Integer> {

    /**
     * Obtiene todos los problemas de un mÃ³dulo.
     * JOIN: problems -> lessons -> units -> modules
     */
    @Query("""
        SELECT p 
        FROM ProblemEntity p
        JOIN LessonEntity l ON p.lessonId = l.id
        JOIN UnitEntity u ON l.unitId = u.id
        JOIN ModuleEntity m ON u.moduleId = m.id
        WHERE m.code = :moduleCode
        ORDER BY u.unitNumber ASC, l.position ASC, p.position ASC
        """)
    List<ProblemEntity> findProblemsByModuleCode(@Param("moduleCode") String moduleCode);

    /**
     * Obtiene problemas de una lecciÃ³n especÃ­fica.
     */
    @Query("""
        SELECT p 
        FROM ProblemEntity p
        WHERE p.lessonId = :lessonId
        ORDER BY p.position ASC
        """)
    List<ProblemEntity> findByLessonIdOrderByPositionAsc(@Param("lessonId") Integer lessonId);

}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/ShopItemJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.ShopItemEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface ShopItemJpaRepository extends JpaRepository<ShopItemEntity, Integer> {
    /**
     * Busca un artÃ­culo por su cÃ³digo de item.
     */
    Optional<ShopItemEntity> findByItemCode(String itemCode);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UnitJpaRepository.java
================================================================================

package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UnitEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;


@Repository
public interface UnitJpaRepository extends JpaRepository<UnitEntity, Integer> {
    /**
     * Obtiene la primera unidad de un mÃ³dulo (ordenada por unit_number).
     *
     * SOLUCIÃ“N: Usar stream().findFirst() para obtener solo el primer resultado.
     *
     * @param moduleCode CÃ³digo del mÃ³dulo
     * @return Primera unidad si existe
     */
    @Query("""
        SELECT u 
        FROM UnitEntity u
        JOIN ModuleEntity m ON u.moduleId = m.id
        WHERE m.code = :moduleCode
        ORDER BY u.unitNumber ASC
        """)
    List<UnitEntity> findByModuleCodeOrderByUnitNumber(@Param("moduleCode") String moduleCode);

    /**
     * Obtiene todas las unidades de un mÃ³dulo.
     *
     * @param moduleCode CÃ³digo del mÃ³dulo
     * @return Lista de unidades ordenadas por nÃºmero
     */
    @Query("""
        SELECT u 
        FROM UnitEntity u
        JOIN ModuleEntity m ON u.moduleId = m.id
        WHERE m.code = :moduleCode
        ORDER BY u.unitNumber ASC
        """)
    List<UnitEntity> findByModuleCode(@Param("moduleCode") String moduleCode);

}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserInventoryJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UserInventoryEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

@Repository
public interface UserInventoryJpaRepository extends JpaRepository<UserInventoryEntity, Long> {

    /**
     * Busca un registro de inventario por usuario y cÃ³digo de item.
     */
    @Query("SELECT inv FROM UserInventoryEntity inv WHERE inv.user.id = :userId AND inv.itemCode = :itemCode")
    Optional<UserInventoryEntity> findByUserIdAndItemCode(@Param("userId") UUID userId, @Param("itemCode") String itemCode);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UserEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import java.util.Optional;
import java.util.UUID;

@Repository
public interface UserJpaRepository extends JpaRepository<UserEntity, UUID> {

    Optional<UserEntity> findByUsername(String username);

    Optional<UserEntity> findByEmail(String email);

    Optional<UserEntity> findByUsernameOrEmail(String username, String email);
    boolean existsByUsernameAndIdNot(String username, UUID id);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserLessonProgressJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UserLessonProgressEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserLessonProgressId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Set;
import java.util.UUID;

@Repository
public interface UserLessonProgressJpaRepository extends JpaRepository<UserLessonProgressEntity, UserLessonProgressId> {

    /**
     * Obtiene un conjunto de IDs de lecciones completadas por un usuario.
     */
    @Query("""
        SELECT ulp.id.lessonId 
        FROM UserLessonProgressEntity ulp 
        WHERE ulp.id.userId = :userId
    """)
    Set<Integer> findCompletedLessonIdsByUserId(@Param("userId") UUID userId);

    /**
     * Verifica la existencia por la clave compuesta.
     * Spring Data JPA genera este query automÃ¡ticamente basado en el nombre.
     */
    boolean existsById_UserIdAndId_LessonId(UUID userId, Integer lessonId);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserProfileJpaRepository.java
================================================================================

    package com.bughuntersaga.api.infrastructure.persistence.repository;

    import com.bughuntersaga.api.infrastructure.persistence.entity.UserProfileEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;


    @Repository
public interface UserProfileJpaRepository extends JpaRepository<UserProfileEntity, UUID> {

        // Contenido de la interfaz

    }


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserStreakJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UserStreakEntity;
import com.bughuntersaga.api.infrastructure.persistence.entity.UserStreakId;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.util.Set;
import java.util.UUID;

@Repository
public interface UserStreakJpaRepository extends JpaRepository<UserStreakEntity, UserStreakId> {

    /**
     * Obtiene un conjunto de todas las fechas de actividad Ãºnicas para un usuario.
     * Optimizado para el cÃ¡lculo de racha.
     */
    @Query("SELECT s.id.activityDate FROM UserStreakEntity s WHERE s.id.userId = :userId")
    Set<LocalDate> findAllActivityDatesByUserId(@Param("userId") UUID userId);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/UserXpHistoryJpaRepository.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository;

import com.bughuntersaga.api.infrastructure.persistence.entity.UserXpHistoryEntity;
import com.bughuntersaga.api.infrastructure.persistence.repository.projections.LeaderboardProjection; // Importar
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.ZonedDateTime;
import java.util.List; // Importar
import java.util.UUID;

@Repository
public interface UserXpHistoryJpaRepository extends JpaRepository<UserXpHistoryEntity, Long> {

    // ... (Queries de SUM de Fase 4) ...
    @Query("SELECT COALESCE(SUM(h.xpEarned), 0) FROM UserXpHistoryEntity h WHERE h.user.id = :userId")
    int sumTotalXpByUserId(@Param("userId") UUID userId);

    @Query("SELECT COALESCE(SUM(h.xpEarned), 0) FROM UserXpHistoryEntity h WHERE h.user.id = :userId AND h.createdAt BETWEEN :start AND :end")
    int sumXpEarnedBetween(@Param("userId") UUID userId, @Param("start") ZonedDateTime start, @Param("end") ZonedDateTime end);

    @Query("""
        SELECT 
            h.user.id as userId, 
            h.user.name as name, 
            SUM(h.xpEarned) as totalXp
        FROM UserXpHistoryEntity h
        WHERE h.createdAt BETWEEN :start AND :end
        GROUP BY h.user.id, h.user.name
        ORDER BY totalXp DESC
    """)
    List<LeaderboardProjection> findLeaderboardForWeek(
            @Param("start") ZonedDateTime start,
            @Param("end") ZonedDateTime end
    );
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/persistence/repository/projections/LeaderboardProjection.java
================================================================================
package com.bughuntersaga.api.infrastructure.persistence.repository.projections;

import java.util.UUID;

/**
 * Interfaz de ProyecciÃ³n de Spring Data para el resultado del query
 * del leaderboard.
 */
public interface LeaderboardProjection {
    UUID getUserId();
    String getName();
    Integer getTotalXp();
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/security/adapter/JwtTokenGeneratorAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.security.adapter;

import com.bughuntersaga.api.application.port.out.TokenGeneratorPort;
import com.bughuntersaga.api.infrastructure.security.jwt.JwtUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class JwtTokenGeneratorAdapter implements TokenGeneratorPort {


    private final JwtUtil jwtUtil;

    @Override
    public String generateToken(String username) {
        return jwtUtil.generateToken(username);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/security/adapter/SpringPasswordEncoderAdapter.java
================================================================================
package com.bughuntersaga.api.infrastructure.security.adapter;

import com.bughuntersaga.api.application.port.out.PasswordEncoderPort;
import lombok.RequiredArgsConstructor;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class SpringPasswordEncoderAdapter implements PasswordEncoderPort {

    // Depende de la implementaciÃ³n de Spring
    private final PasswordEncoder passwordEncoder;

    @Override
    public String encode(String rawPassword) {
        return passwordEncoder.encode(rawPassword);
    }

    @Override
    public boolean matches(String rawPassword, String encodedPassword) {
        return passwordEncoder.matches(rawPassword, encodedPassword);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/security/config/SecurityConfiguration.java
================================================================================

package com.bughuntersaga.api.infrastructure.security.config;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import com.bughuntersaga.api.infrastructure.security.filter.JwtAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfiguration {

    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .cors(cors -> cors.configurationSource(corsConfigurationSource()))
                .csrf(csrf -> csrf.disable())
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/auth/**").permitAll()
                        .requestMatchers(
                                "/",
                                "/swagger-ui.html",
                                "/swagger-ui/**",
                                "/v3/api-docs/**")
                        .permitAll()
                        .requestMatchers("/api/content/modules").permitAll()
                        .anyRequest().authenticated())
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(java.util.Arrays.asList(
                "*"));
        configuration.setAllowedMethods(java.util.Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"));
        configuration.setAllowedHeaders(java.util.Arrays.asList("*"));
        configuration.setAllowCredentials(false);
        configuration.setMaxAge(3600L);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/security/filter/JwtAuthenticationFilter.java
================================================================================
package com.bughuntersaga.api.infrastructure.security.filter;

import lombok.RequiredArgsConstructor;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import com.bughuntersaga.api.infrastructure.security.jwt.JwtUtil;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;

@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private final JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {

        try {
            String authHeader = request.getHeader("Authorization");
            String token = null;
            String username = null;

            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                token = authHeader.substring(7);
                username = jwtUtil.extractUsername(token);
            }

            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                if (jwtUtil.isTokenValid(token)) {
                    UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                            username, null, null);
                    authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
                    SecurityContextHolder.getContext().setAuthentication(authentication);
                }
            }
        } catch (Exception e) {
            // Log error if needed, continue with filter chain
        }

        filterChain.doFilter(request, response);
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/security/jwt/JwtUtil.java
================================================================================
package com.bughuntersaga.api.infrastructure.security.jwt;

import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Component
public class JwtUtil {

    private final String secretKey;
    private final long expirationMs;

    public JwtUtil(
            @Value("${app.jwt.secret:your-secret-key-must-be-at-least-256-bits-long-for-hs256}") String secretKey,
            @Value("${app.jwt.expiration:86400000}") long expirationMs) {
        this.secretKey = secretKey;
        this.expirationMs = expirationMs;
    }

    public String generateToken(String username) {
        return Jwts.builder()
                .subject(username)
                .issuedAt(new Date())
                .expiration(new Date(System.currentTimeMillis() + expirationMs))
                .signWith(Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8)))
                .compact();
    }

    public String extractUsername(String token) {
        try {
            return Jwts.parser()
                    .verifyWith(Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8)))
                    .build()
                    .parseSignedClaims(token)
                    .getPayload()
                    .getSubject();
        } catch (Exception e) {
            return null;
        }
    }

    public boolean isTokenValid(String token) {
        try {
            Jwts.parser()
                    .verifyWith(Keys.hmacShaKeyFor(secretKey.getBytes(StandardCharsets.UTF_8)))
                    .build()
                    .parseSignedClaims(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/AuthController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;

import com.bughuntersaga.api.application.dto.ForgotPasswordCommand;
import com.bughuntersaga.api.application.dto.LoginUserCommand;
import com.bughuntersaga.api.application.dto.RegisterUserCommand;
import com.bughuntersaga.api.application.port.in.ForgotPasswordUseCase;
import com.bughuntersaga.api.application.port.in.LoginUserUseCase;
import com.bughuntersaga.api.application.port.in.RegisterUserUseCase;
import com.bughuntersaga.api.domain.model.AuthToken;
import com.bughuntersaga.api.infrastructure.web.dto.ForgotPasswordDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserRegistrationDTO;
import com.bughuntersaga.api.infrastructure.web.mapper.AuthApiMapper;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import com.bughuntersaga.api.infrastructure.web.dto.UserLoginDTO;
import com.bughuntersaga.api.infrastructure.web.dto.AuthResponseDTO;

import java.util.Map;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/auth")
public class AuthController {

    private final RegisterUserUseCase registerUserUseCase;
    private final LoginUserUseCase loginUserUseCase;
    private final AuthApiMapper authApiMapper;
    private final ForgotPasswordUseCase forgotPasswordUseCase;

    @PostMapping("/register")
    public ResponseEntity<AuthResponseDTO> register(@Valid @RequestBody UserRegistrationDTO request) {


        RegisterUserCommand command = authApiMapper.toRegisterCommand(request);
        AuthToken authToken = registerUserUseCase.register(command);
        AuthResponseDTO response = authApiMapper.toAuthResponseDTO(authToken);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }

    @PostMapping("/login")
    public ResponseEntity<AuthResponseDTO> login(@Valid @RequestBody UserLoginDTO request) {


        LoginUserCommand command = authApiMapper.toLoginCommand(request);
        AuthToken authToken = loginUserUseCase.login(command);
        AuthResponseDTO response = authApiMapper.toAuthResponseDTO(authToken);
        return ResponseEntity.ok(response);
    }
    /**
     * POST /api/auth/forgot-password (Fase 7)
     */
    @PostMapping("/forgot-password")
    public ResponseEntity<Map<String, String>> forgotPassword(
            @Valid @RequestBody ForgotPasswordDTO forgotPasswordDTO) {

        // 1. Mapear
        ForgotPasswordCommand command = authApiMapper.toCommand(forgotPasswordDTO);

        // 2. Ejecutar
        forgotPasswordUseCase.handle(command);

        // 3. Devolver siempre una respuesta genÃ©rica (por seguridad)
        Map<String, String> response = Map.of(
                "message", "Si tu email estÃ¡ registrado, recibirÃ¡s un enlace para resetear tu contraseÃ±a."
        );

        return ResponseEntity.ok(response);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/ContentController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;

import com.bughuntersaga.api.application.port.in.GetModuleProblemsUseCase;
import com.bughuntersaga.api.application.port.in.GetModuleUnitUseCase;
import com.bughuntersaga.api.application.port.in.GetModulesUseCase;
import com.bughuntersaga.api.domain.model.Module;
import com.bughuntersaga.api.domain.model.Problem;
import com.bughuntersaga.api.domain.model.Unit;
import com.bughuntersaga.api.infrastructure.web.dto.ModuleResponseDTO;
import com.bughuntersaga.api.infrastructure.web.dto.ProblemDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UnitDetailDTO;
import com.bughuntersaga.api.infrastructure.web.mapper.ContentApiMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/content/modules")
public class ContentController {

    private final ContentApiMapper contentApiMapper;
    private final GetModulesUseCase getModulesUseCase;
    private final GetModuleProblemsUseCase getModuleProblemsUseCase;
    private final GetModuleUnitUseCase getModuleUnitUseCase;


    @GetMapping("")
    public ResponseEntity<List<ModuleResponseDTO>> getModules() {
        List<Module> modules = getModulesUseCase.getModules();
        List<ModuleResponseDTO> moduleResponseDTOs = modules.stream().map(contentApiMapper::toModuleResponseDTO)
                .collect(Collectors.toList());
        return ResponseEntity.ok(moduleResponseDTOs);
    }

    @GetMapping("/{moduleCode}/problems")
    public ResponseEntity<List<ProblemDTO>> getProblemsByModule(@PathVariable("moduleCode") String moduleCode) {
        List<Problem> problems = getModuleProblemsUseCase.getModuleProblems(moduleCode);
        List<ProblemDTO> problemDTOS = problems.stream().map(contentApiMapper::toProblemDTO)
                .collect(Collectors.toList());
        return ResponseEntity.ok(problemDTOS);
    }


    @GetMapping("/{moduleCode}/unit")
    public ResponseEntity<UnitDetailDTO> getUnitsByModule(@PathVariable("moduleCode") String moduleCode) {
        // Ejecutar caso de uso
        Unit unit = getModuleUnitUseCase.getModuleUnit(moduleCode);

        // Convertir a DTO
        UnitDetailDTO response = contentApiMapper.toUnitDTO(unit);
        return ResponseEntity.ok(response);
    }

}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/GamificationController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;

import com.bughuntersaga.api.application.port.in.GetLeaderboardUseCase;
import com.bughuntersaga.api.application.port.in.GetShopItemsUseCase;
import com.bughuntersaga.api.application.port.in.PurchaseItemUseCase;
import com.bughuntersaga.api.application.port.in.UserStatsResult;
import com.bughuntersaga.api.domain.model.Leaderboard;
import com.bughuntersaga.api.domain.model.ShopItem;
import com.bughuntersaga.api.infrastructure.web.dto.LeaderboardDTO;
import com.bughuntersaga.api.infrastructure.web.dto.ShopItemDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserStatsDTO;
import com.bughuntersaga.api.infrastructure.web.mapper.GamificationApiMapper;
import com.bughuntersaga.api.infrastructure.web.mapper.UserApiMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api")
public class GamificationController {

    private final GetLeaderboardUseCase getLeaderboardUseCase;
    private final GetShopItemsUseCase getShopItemsUseCase;
    private final PurchaseItemUseCase purchaseItemUseCase;

    // Mappers
    private final GamificationApiMapper gamificationApiMapper;
    private final UserApiMapper userApiMapper;

    /**
     * GET /api/leaderboard (Fase 6)
     */
    @GetMapping("/leaderboard")
    public ResponseEntity<LeaderboardDTO> getLeaderboard() {

        // 1. Ejecutar el caso de uso
        Leaderboard leaderboard = getLeaderboardUseCase.getLeaderboard();

        // 2. Mapear de Dominio (App) a DTO (Web)
        LeaderboardDTO responseDTO = gamificationApiMapper.toLeaderboardDTO(leaderboard);

        return ResponseEntity.ok(responseDTO);
    }

    /**
     * GET /api/shop/items (Fase 6)
     */
    @GetMapping("/shop/items")
    public ResponseEntity<List<ShopItemDTO>> getShopItems() {
        // ... (implementado)
        List<ShopItem> items = getShopItemsUseCase.getShopItems();
        List<ShopItemDTO> responseDTOs = items.stream()
                .map(gamificationApiMapper::toShopItemDTO)
                .collect(Collectors.toList());
        return ResponseEntity.ok(responseDTOs);
    }

    /**
     * POST /api/shop/purchase/{itemId} (Fase 6)
     */
    @PostMapping("/shop/purchase/{itemId}")
    public ResponseEntity<UserStatsDTO> purchaseItem(@PathVariable("itemId") String itemId) {
        // ... (implementado)
        UserStatsResult updatedStats = purchaseItemUseCase.purchaseItem(itemId);
        UserStatsDTO responseDTO = userApiMapper.toStatsDTO(updatedStats);
        return ResponseEntity.ok(responseDTO);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/ProgressController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;

import com.bughuntersaga.api.application.dto.CompleteLessonCommand;
import com.bughuntersaga.api.application.port.in.ClaimTreasureResult;
import com.bughuntersaga.api.application.port.in.ClaimTreasureUseCase;
import com.bughuntersaga.api.application.port.in.CompleteLessonResult;
import com.bughuntersaga.api.application.port.in.CompleteLessonUseCase;
import com.bughuntersaga.api.infrastructure.web.dto.LessonCompletionResponseDTO;
import com.bughuntersaga.api.infrastructure.web.dto.LessonResultDTO;
import com.bughuntersaga.api.infrastructure.web.mapper.ProgressApiMapper;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/progress")
public class ProgressController {

    private final CompleteLessonUseCase completeLessonUseCase;
    private final ClaimTreasureUseCase claimTreasureUseCase;
    private final ProgressApiMapper progressApiMapper; // AÃ±adido

    /**
     * Endpoint para registrar la finalizaciÃ³n de una lecciÃ³n (Fase 3).
     * Coincide con: POST /api/progress/lesson
     */
    @PostMapping("/lesson")
    public ResponseEntity<LessonCompletionResponseDTO> completeLesson(
            @Valid @RequestBody LessonResultDTO lessonResultDTO) {

        // 1. Mapear DTO (web) a Comando (app)
        CompleteLessonCommand command = progressApiMapper.toCommand(lessonResultDTO);

        // 2. Ejecutar el caso de uso
        CompleteLessonResult result = completeLessonUseCase.handle(command);

        // 3. Mapear Resultado (app) a DTO (web)
        LessonCompletionResponseDTO responseDTO = progressApiMapper.toDTO(result);

        return ResponseEntity.ok(responseDTO);
    }

    /**
     * Endpoint para reclamar un tesoro (Fase 4).
     * Coincide con: POST /api/progress/treasure/{lessonId}
     */
    @PostMapping("/treasure/{lessonId}")
    public ResponseEntity<Map<String, Integer>> claimTreasure(@PathVariable("lessonId") Integer lessonId) {

        ClaimTreasureResult result = claimTreasureUseCase.claimTreasure(lessonId);

        Map<String, Integer> response = Map.of(
                "lingotsEarned", result.lingotsEarned(),
                "totalLingots", result.totalLingots()
        );

        return ResponseEntity.ok(response);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/SwaggerRedirectController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.servlet.view.RedirectView;

@Controller
public class SwaggerRedirectController {

    @GetMapping("/")
    public RedirectView redirectToSwaggerUi() {
        return new RedirectView("/swagger-ui.html", true);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/controller/UserController.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.controller;

import com.bughuntersaga.api.application.dto.UpdateUserAccountCommand;
import com.bughuntersaga.api.application.dto.UpdateUserSettingsCommand;
import com.bughuntersaga.api.application.port.in.*;
import com.bughuntersaga.api.domain.model.FullUserProfile;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.infrastructure.web.dto.UserAccountUpdateDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserInfoDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserProfileDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserSettingsUpdateDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserStatsDTO;
import com.bughuntersaga.api.infrastructure.web.mapper.UserApiMapper;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequiredArgsConstructor
@RequestMapping("/api/users")
public class UserController {

    // Casos de uso
    private final GetUserProfileUseCase getUserProfileUseCase;
    private final UpdateUserAccountUseCase updateUserAccountUseCase;
    private final UpdateUserSettingsUseCase updateUserSettingsUseCase;
    private final GetUserStatsUseCase getUserStatsUseCase;

    // Mappers
    private final UserApiMapper userApiMapper;

    /**
     * GET /api/users/me/profile (Fase 5)
     */
    @GetMapping("/me/profile")
    public ResponseEntity<UserProfileDTO> getUserProfile() {
        FullUserProfile profileDomain = getUserProfileUseCase.getProfile();
        UserProfileDTO responseDTO = userApiMapper.toProfileDTO(profileDomain);
        return ResponseEntity.ok(responseDTO);
    }

    /**
     * PUT /api/users/me/account (Fase 5)
     */
    @PutMapping("/me/account")
    public ResponseEntity<UserInfoDTO> updateUserAccount(
            @Valid @RequestBody UserAccountUpdateDTO accountUpdateDTO) {

        UpdateUserAccountCommand command = userApiMapper.toCommand(accountUpdateDTO);
        User updatedUser = updateUserAccountUseCase.updateAccount(command);
        UserInfoDTO responseDTO = userApiMapper.toUserInfoDTO(updatedUser);
        return ResponseEntity.ok(responseDTO);
    }

    /**
     * PUT /api/users/me/settings (Fase 5)
     */
    @PutMapping("/me/settings")
    public ResponseEntity<UserProfileDTO> updateUserSettings(
            @Valid @RequestBody UserSettingsUpdateDTO settingsUpdateDTO) {

        UpdateUserSettingsCommand command = userApiMapper.toCommand(settingsUpdateDTO);
        FullUserProfile updatedProfile = updateUserSettingsUseCase.updateSettings(command);
        UserProfileDTO responseDTO = userApiMapper.toProfileDTO(updatedProfile);
        return ResponseEntity.ok(responseDTO);
    }

    /**
     * GET /api/users/me/stats (Fase 4)
     */
    @GetMapping("/me/stats")
    public ResponseEntity<UserStatsDTO> getUserStats() {
        UserStatsResult result = getUserStatsUseCase.getStats();
        UserStatsDTO responseDTO = userApiMapper.toStatsDTO(result);
        return ResponseEntity.ok(responseDTO);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/AuthResponseDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.*;
import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)

/**
 * DTO para AuthResponseDTO.
 * Schema: AuthResponseDTO de OpenAPI
 */
public record AuthResponseDTO(
        // Schema: AuthResponseDTO de OpenAPI
        String token,
        UserInfoDTO user) {
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/ErrorDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;


import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ErrorDTO {
    private LocalDateTime timestamp;
    private Integer status;
    private String error;
    private String message;
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/ForgotPasswordDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record ForgotPasswordDTO(
        @NotBlank(message = "El email es obligatorio")
        @Email(message = "Debe ser un email vÃ¡lido")
        String email
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/LeaderboardDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import java.util.List;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record LeaderboardDTO(
        String leagueName,
        String timeUntilEnd,
        List<LeaderboardEntryDTO> users
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/LeaderboardEntryDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record LeaderboardEntryDTO(
        Integer rank,
        String name,
        Integer xp,
        Boolean isCurrentUser
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/LessonCompletionResponseDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record LessonCompletionResponseDTO(
        Integer xpEarned,
        Integer lingotsEarned,
        Integer newTotalLingots,
        Integer newStreak
) {
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/LessonResultDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotNull;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record LessonResultDTO(
        @NotNull(message = "Lesson ID is required")
        @Min(value = 1, message = "Lesson ID must be positive")
        Integer lessonId,

        @NotNull(message = "Correct answer count is required")
        @Min(value = 0, message = "Correct answer count cannot be negative")
        Integer correctAnswerCount,

        @NotNull(message = "Incorrect answer count is required")
        @Min(value = 0, message = "Incorrect answer count cannot be negative")
        Integer incorrectAnswerCount,

        @NotNull(message = "Time taken is required")
        @Min(value = 0, message = "Time taken cannot be negative")
        Long timeTakenMs,

        @NotNull(message = "Is practice flag is required")
        Boolean isPractice
) {
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/LessonTileDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.*;
import com.fasterxml.jackson.annotation.JsonInclude;
@JsonInclude(JsonInclude.Include.NON_NULL)

/**
 * DTO para LessonTileDTO.
 * Schema: LessonTileDTO de OpenAPI
 */
public record LessonTileDTO(
        Integer lessonId,
        String type,           // "star", "book", "trophy", "treasure", "fast-forward"
        String description,
        String status
) {
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/ModuleResponseDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import java.util.Map;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record ModuleResponseDTO(
        Integer id,
        String code,
        String name,
        String shortName,
        String description,
        Map<String, Object> uiConfig
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/ProblemDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;

import java.util.List;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record ProblemDTO(
        String type,
        String moduleTitle,
        String introduction,
        List<String> objectives,
        String question,
        List<AnswerOption> answers,
        Integer correctAnswer,
        List<String> answerTiles,
        List<Integer> correctAnswerIndices
)
{
    public record AnswerOption(String name) {}
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/ShopItemDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record ShopItemDTO(
        String itemId,
        String name,
        String description,
        Integer cost
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UnitDetailDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.*;
import com.fasterxml.jackson.annotation.JsonInclude;

import java.util.List;

@JsonInclude(JsonInclude.Include.NON_NULL)

/**
 * DTO para UnitDetailDTO.
 * Schema: UnitDetailDTO de OpenAPI
 */
public record UnitDetailDTO(
        Integer unitNumber,
        String description,
        String backgroundColor,
        String textColor,
        String borderColor,
        List<LessonTileDTO> tiles
) {
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserAccountUpdateDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import jakarta.validation.constraints.Size;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record UserAccountUpdateDTO(
        @Size(max = 100)
        String name,

        @Size(min = 3, max = 50)
        String username
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserInfoDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.*;
import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)

/**
 * DTO para UserInfoDTO.
 * Schema: UserInfoDTO de OpenAPI
 */
public record UserInfoDTO(
        // Schema: UserInfoDTO de OpenAPI
        String id,
        String username,
        String name,
        String email) {
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserLoginDTO.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.*;
import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)

/**
 * DTO para UserLoginDTO.
 * Schema: UserLoginDTO de OpenAPI
 */
public record UserLoginDTO(
        // Schema: UserLoginDTO de OpenAPI
        String emailOrUsername,
        String password) {
}


================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserProfileDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import java.time.LocalDateTime;
import java.util.UUID;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record UserProfileDTO(
        UUID userId,
        String name,
        String username,
        String email,
        LocalDateTime joinedAt,
        Integer lingots,
        Integer dailyXpGoal,
        Boolean soundEffectsEnabled
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserRegistrationDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

public record UserRegistrationDTO(
        @NotBlank(message = "El username es obligatorio")
        @Size(min = 3, message = "El username debe tener al menos 3 caracteres")
        String username,

        @NotBlank(message = "El nombre es obligatorio")
        String name,

        @NotBlank(message = "El email es obligatorio")
        @Email(message = "El email debe ser vÃ¡lido")
        String email,

        @NotBlank(message = "La contraseÃ±a es obligatoria")
        @Size(min = 8, message = "La contraseÃ±a debe tener al menos 8 caracteres")
        String password
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserSettingsUpdateDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record UserSettingsUpdateDTO(
        Integer dailyXpGoal, // (Tu OpenAPI permite [1, 10, 20, 30, 50])
        Boolean soundEffectsEnabled,
        Boolean speakingExercises,
        Boolean listeningExercises
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/dto/UserStatsDTO.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import java.time.LocalDate;
import java.util.Set;

@JsonInclude(JsonInclude.Include.NON_NULL)
public record UserStatsDTO(
        Integer totalXp,
        Integer totalLingots,
        Integer currentStreak,
        Integer xpToday,
        Integer xpThisWeek,
        Integer leagueRank, // Puede ser nulo
        Set<LocalDate> activeDays
) {}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/exception/GlobalApiExceptionHandler.java
================================================================================

package com.bughuntersaga.api.infrastructure.web.exception;

import com.bughuntersaga.api.domain.exception.*;
import com.bughuntersaga.api.infrastructure.web.dto.ErrorDTO;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import java.time.LocalDateTime;
import java.util.stream.Collectors;
import lombok.extern.slf4j.Slf4j;

/**
 * Manejador global de excepciones para la API.
 *
 * Responsabilidades:
 * - Capturar excepciones de dominio y convertirlas en respuestas HTTP
 * - Capturar excepciones de validaciÃ³n de Spring
 * - Retornar ErrorDTO segÃºn el contrato de la API
 * - Proporcionar mensajes de error consistentes
 */
@Slf4j
@RestControllerAdvice
public class GlobalApiExceptionHandler {




    /**
     * Maneja UserAlreadyExistsException (400 Bad Request).
     */
    @ExceptionHandler(UsernameAlreadyExistsException.class)
    public ResponseEntity<ErrorDTO> handleUserAlreadyExists(UsernameAlreadyExistsException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.BAD_REQUEST.value())
                .error("Bad Request")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }

    /**
     * Maneja InvalidCredentialsException (401 Unauthorized).
     */
    @ExceptionHandler(InvalidCredentialsException.class)
    public ResponseEntity<ErrorDTO> handleInvalidCredentials(InvalidCredentialsException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.UNAUTHORIZED.value())
                .error("Unauthorized")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error);
    }

    /**
     * Maneja ResourceNotFoundException (404 Not Found).
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorDTO> handleResourceNotFound(ResourceNotFoundException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.NOT_FOUND.value())
                .error("Not Found")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }

    // ========================================================================
    // NUEVOS HANDLERS PARA FASE 3: Registrar Progreso
    // ========================================================================

    /**
     * Maneja LessonNotFoundException (404 Not Found).
     * Se lanza cuando se intenta completar una lecciÃ³n que no existe.
     */
    @ExceptionHandler(LessonNotFoundException.class)
    public ResponseEntity<ErrorDTO> handleLessonNotFound(LessonNotFoundException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.NOT_FOUND.value())
                .error("Not Found")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }

    /**
     * Maneja LessonAlreadyCompletedException (409 Conflict).
     * Se lanza cuando un usuario intenta completar una lecciÃ³n que ya completÃ³ previamente.
     */
    @ExceptionHandler(LessonAlreadyCompletedException.class)
    public ResponseEntity<ErrorDTO> handleLessonAlreadyCompleted(LessonAlreadyCompletedException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.CONFLICT.value())
                .error("Conflict")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.CONFLICT).body(error);
    }


    /**
     * Maneja errores de validaciÃ³n de Spring (400 Bad Request).
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorDTO> handleValidationErrors(MethodArgumentNotValidException ex) {
        String message = ex.getBindingResult().getFieldErrors().stream()
                .map(FieldError::getDefaultMessage)
                .collect(Collectors.joining(", "));

        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.BAD_REQUEST.value())
                .error("Validation Error")
                .message(message)
                .build();

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<ErrorDTO> handleIllegalArgument(IllegalArgumentException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.BAD_REQUEST.value())
                .error("Bad Request")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
    /**
     * Maneja CUALQUIER otra excepciÃ³n no capturada (500 Internal Server Error).
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorDTO> handleGenericException(Exception ex) {


        log.error("Error 500 no controlado: {}", ex.getMessage(), ex);

        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.INTERNAL_SERVER_ERROR.value())
                .error("Internal Server Error")
                .message("Ha ocurrido un error inesperado: " + ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(error);
    }

    // --- NUEVO HANDLER (Contrato: POST /shop/purchase) ---
    /**
     * Maneja InsufficientFundsException (400 Bad Request).
     * Definido en el contrato como un error 400.
     */
    @ExceptionHandler(InsufficientFundsException.class)
    public ResponseEntity<ErrorDTO> handleInsufficientFunds(InsufficientFundsException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.BAD_REQUEST.value())
                .error("Bad Request")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }

    // --- NUEVO HANDLER (Contrato: POST /progress/treasure) ---
    /**
     * Maneja TreasureAlreadyClaimedException (400 Bad Request).
     * Definido en el contrato como un error 400.
     */
    @ExceptionHandler(TreasureAlreadyClaimedException.class)
    public ResponseEntity<ErrorDTO> handleTreasureAlreadyClaimed(TreasureAlreadyClaimedException ex) {
        ErrorDTO error = ErrorDTO.builder()
                .timestamp(LocalDateTime.now())
                .status(HttpStatus.BAD_REQUEST.value())
                .error("Bad Request")
                .message(ex.getMessage())
                .build();

        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/mapper/AuthApiMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.mapper;

import com.bughuntersaga.api.application.dto.ForgotPasswordCommand;
import com.bughuntersaga.api.application.dto.LoginUserCommand;
import com.bughuntersaga.api.application.dto.RegisterUserCommand;
import com.bughuntersaga.api.domain.model.AuthToken;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.infrastructure.web.dto.*;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface AuthApiMapper {

    // Mapeo de DTO a Comando
    @Mapping(source = "password", target = "rawPassword")
    RegisterUserCommand toRegisterCommand(UserRegistrationDTO dto);

    // Mapeo de DTO de Login a Comando de Login
    LoginUserCommand toLoginCommand(UserLoginDTO dto);

    // Mapeo de AuthToken a DTO de respuesta
    AuthResponseDTO toAuthResponseDTO(AuthToken authToken);

    // Info bÃ¡sica del usuario
    @Mapping(source = "id", target = "id")
    UserInfoDTO toUserInfoDTO(User user);
    ForgotPasswordCommand toCommand(ForgotPasswordDTO dto);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/mapper/ContentApiMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.mapper;

import com.bughuntersaga.api.domain.model.Lesson;
import com.bughuntersaga.api.domain.model.Problem;
import com.bughuntersaga.api.domain.model.Unit;
import com.bughuntersaga.api.infrastructure.web.dto.LessonTileDTO;
import com.bughuntersaga.api.infrastructure.web.dto.ModuleResponseDTO;
import com.bughuntersaga.api.domain.model.Module;
import com.bughuntersaga.api.infrastructure.web.dto.ProblemDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UnitDetailDTO;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

import java.util.stream.Collectors;


@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface ContentApiMapper {

    @Mapping(source = "name", target = "shortName")
    ModuleResponseDTO toModuleResponseDTO(Module module);


    UnitDetailDTO toUnitDetailDTO(Unit unit);

    @Mapping(target = "answers", expression = "java(mapAnswers(problem))")
    ProblemDTO toProblemDTO(Problem problem);

    default java.util.List<ProblemDTO.AnswerOption> mapAnswers(Problem problem) {
        if (problem.getAnswers() == null) return null;
        return problem.getAnswers().stream()
                .map(answer -> new ProblemDTO.AnswerOption(answer.getName()))
                .collect(Collectors.toList());
    }
    /**
     * Convierte Unit â†’ UnitDTO
     * NOTA: Los colores (backgroundColor, textColor, borderColor)
     * no estÃ¡n en el dominio Unit. Deben ser configurados
     * manualmente o venir del mÃ³dulo.
     */
    @Mapping(target = "backgroundColor", constant = "bg-blue-500")
    @Mapping(target = "textColor", constant = "text-white")
    @Mapping(target = "borderColor", constant = "border-blue-700")
    @Mapping(target = "tiles", source = "lessons")
    UnitDetailDTO toUnitDTO(Unit unit);

    /**
     * Convierte Lesson â†’ LessonTileDTO.
     */
    @Mapping(target = "lessonId", source = "id")
    LessonTileDTO toLessonTileDTO(Lesson lesson);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/mapper/GamificationApiMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.mapper;

import com.bughuntersaga.api.domain.model.Leaderboard;
import com.bughuntersaga.api.domain.model.LeaderboardEntry;
import com.bughuntersaga.api.domain.model.ShopItem;
import com.bughuntersaga.api.infrastructure.web.dto.LeaderboardDTO;
import com.bughuntersaga.api.infrastructure.web.dto.LeaderboardEntryDTO;
import com.bughuntersaga.api.infrastructure.web.dto.ShopItemDTO;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface GamificationApiMapper {


    @Mapping(source = "itemCode", target = "itemId")
    ShopItemDTO toShopItemDTO(ShopItem domain);


    LeaderboardDTO toLeaderboardDTO(Leaderboard domain);
    LeaderboardEntryDTO toLeaderboardEntryDTO(LeaderboardEntry domain);

}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/mapper/ProgressApiMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.mapper;

import com.bughuntersaga.api.application.dto.CompleteLessonCommand;
import com.bughuntersaga.api.application.port.in.CompleteLessonResult;
import com.bughuntersaga.api.infrastructure.web.dto.LessonCompletionResponseDTO;
import com.bughuntersaga.api.infrastructure.web.dto.LessonResultDTO;
import org.mapstruct.Mapper;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface ProgressApiMapper {

    /**
     * Mapea el DTO web de entrada al Comando de aplicaciÃ³n.
     */
    CompleteLessonCommand toCommand(LessonResultDTO dto);

    /**
     * Mapea el Resultado de dominio al DTO web de salida.
     */
    LessonCompletionResponseDTO toDTO(CompleteLessonResult result);
}

================================================================================
ğŸ“„ CONTENIDO DE: infrastructure/web/mapper/UserApiMapper.java
================================================================================
package com.bughuntersaga.api.infrastructure.web.mapper;

import com.bughuntersaga.api.application.dto.UpdateUserAccountCommand;
import com.bughuntersaga.api.application.dto.UpdateUserSettingsCommand;
import com.bughuntersaga.api.application.port.in.UserStatsResult;
import com.bughuntersaga.api.domain.model.FullUserProfile;
import com.bughuntersaga.api.domain.model.User;
import com.bughuntersaga.api.infrastructure.web.dto.UserAccountUpdateDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserInfoDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserProfileDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserSettingsUpdateDTO;
import com.bughuntersaga.api.infrastructure.web.dto.UserStatsDTO;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.ReportingPolicy;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface UserApiMapper {

    // --- Fase 4 ---
    UserStatsDTO toStatsDTO(UserStatsResult result);

    /**
     * Mapea el modelo de dominio combinado al DTO de respuesta.
     */
    UserProfileDTO toProfileDTO(FullUserProfile domain);

    /**
     * Mapea el DTO de entrada de settings al Comando de aplicaciÃ³n.
     */
    UpdateUserSettingsCommand toCommand(UserSettingsUpdateDTO dto);

    /**
     * Mapea el DTO de entrada de account al Comando de aplicaciÃ³n.
     */
    UpdateUserAccountCommand toCommand(UserAccountUpdateDTO dto);

    /**
     * Mapea el User de dominio al UserInfoDTO (usado por /account y /login).
     */
    @Mapping(source = "id", target = "id")
    UserInfoDTO toUserInfoDTO(User user);
}